<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Multiple Regimen MCP-Mod • DoseFinding</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Multiple Regimen MCP-Mod">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DoseFinding</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analysis_normal.html">Continuous data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/binary_data.html">Binary Data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">MCP-Mod FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/mult_regimen.html">Multiple Regimen MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/overview.html">Overview DoseFinding package</a></li>
    <li><a class="dropdown-item" href="../articles/sample_size.html">Sample size calculations for MCP-Mod</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/DoseFinding/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Multiple Regimen MCP-Mod</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/DoseFinding/blob/master/vignettes/mult_regimen.Rmd" class="external-link"><code>vignettes/mult_regimen.Rmd</code></a></small>
      <div class="d-none name"><code>mult_regimen.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="background">Background<a class="anchor" aria-label="anchor" href="#background"></a>
</h2>
<p>Often more than one regimen is studied in dose-finding studies. If
there are enough doses within each regimen, one may still utilize
MCP-Mod. But specific assumptions are needed, and it depends on the
situation, whether or not these are appropriate (and thus usage of
MCP-Mod).</p>
<p>The first idea is to bring the doses for each regimen on a common
scale (total dose per time unit). For example if once daily (od) dosing
and twice daily (bid) dosing are used in a study, one might utilize the
total daily dose.</p>
<p>It is usually not appropriate to then perform MCP-Mod on the total
daily dose (ignoring from which regimen the doses originate): The study
investigated more than one regimen, so assessing the difference between
regimen (for example for the same total daily dose) is of interest. This
would not be possible with a modelling approach that ignores the
regimen.</p>
<p>The most general approach would be to perform MCP-Mod separately by
regimen, and for example to adjust p-values originating from the
MCP-part using a Bonferroni correction. This approach assumes that the
regimen don’t share any similarity. Due to the double-blind nature of
trials, all patients would receive two administrations per day (patients
in the od group receive one placebo per day), so that there is no real
od group and in particular no separate placebo od group. So it often
makes more sense to assume that the placebo group is common to both the
od and bid dose-response curve. For the MCP-step contrasts for both od
and bid are taken with respect to the same placebo group and in the
modelling step one would assume the intercept to be the same across
regimen, but all other parameters separate.</p>
<p>One could also assume further parameters to be common across regimen
(for example the Emax or the ED50 parameter for the Emax model), but in
the following example no such assumption is made.</p>
<p>The motivation for the simulated data below is taken from a recently
completed dose-finding study, where the dose-response of the drug
Licogliflozin was assessed for the od and bid regimen <span class="citation">(<a href="#ref-bays2020">Bays et al. 2020</a>)</span>,
see also the <a href="https://clinicaltrials.gov/ct2/show/results/NCT03100058" class="external-link">corresponding
page at clinicaltrials.gov</a>.</p>
<p>Note that this study used MCP-Mod, but the analysis presented here
has been modified and simplified (in terms of candidate models and
dose-response modelling strategy).</p>
<p>For most of the following code it is useful to structure the
first-stage estimates like this: <span class="math display">\[
\hat\mu=(\hat\mu_{\mathrm{placebo}}, \hat\mu_{\mathrm{od}},
\hat\mu_{\mathrm{bid}})
\]</span> The length of the sub-vectors <span class="math inline">\(\hat\mu_{\mathrm{od}}\)</span> and <span class="math inline">\(\hat\mu_{\mathrm{bid}}\)</span> correspond to the
number of different doses in the two regimens. They can be different,
but in our example both have 4 elements.</p>
<p>Also as discussed above everything is modeled on the total daily dose
scale.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/openpharma/DoseFinding" class="external-link">DoseFinding</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="co">## collect estimates and dosage information in one place</span></span>
<span><span class="va">example_estimates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## ANOVA mean estimates and ci bounds extracted from fig. 3 of Bays (2020).</span></span>
<span>  <span class="co">## clinicaltrials.gov page already seems to contain values from the dose-response model fit</span></span>
<span>  <span class="va">mn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.55</span>, <span class="op">-</span><span class="fl">1.78</span>, <span class="op">-</span><span class="fl">1.95</span>, <span class="op">-</span><span class="fl">3.29</span>, <span class="op">-</span><span class="fl">4.43</span>, <span class="op">-</span><span class="fl">1.14</span>, <span class="op">-</span><span class="fl">2.74</span>, <span class="op">-</span><span class="fl">4.03</span>, <span class="op">-</span><span class="fl">4.47</span><span class="op">)</span></span>
<span>  <span class="va">lb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1.56</span>, <span class="op">-</span><span class="fl">3.15</span>, <span class="op">-</span><span class="fl">3.36</span>, <span class="op">-</span><span class="fl">4.85</span>, <span class="op">-</span><span class="fl">5.40</span>, <span class="op">-</span><span class="fl">2.49</span>, <span class="op">-</span><span class="fl">4.10</span>, <span class="op">-</span><span class="fl">5.50</span>, <span class="op">-</span><span class="fl">5.50</span><span class="op">)</span></span>
<span>  <span class="va">ub</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span> <span class="fl">0.40</span>, <span class="op">-</span><span class="fl">0.30</span>, <span class="op">-</span><span class="fl">0.54</span>, <span class="op">-</span><span class="fl">1.76</span>, <span class="op">-</span><span class="fl">3.48</span>, <span class="fl">0.24</span>, <span class="op">-</span><span class="fl">1.38</span>, <span class="op">-</span><span class="fl">2.65</span>, <span class="op">-</span><span class="fl">3.44</span><span class="op">)</span></span>
<span>  <span class="va">se</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">ub</span> <span class="op">-</span> <span class="va">lb</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="co"># approximate standard error</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu_hat <span class="op">=</span> <span class="va">mn</span>,</span>
<span>              daily_dose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.5</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">150</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>              S_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">se</span><span class="op">^</span><span class="fl">2</span><span class="op">)</span>,</span>
<span>              <span class="co"># keep track of which elements correspond to which regimen:</span></span>
<span>              index <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>placebo <span class="op">=</span> <span class="fl">1</span>, od <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">5</span>, bid <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">9</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## restructure estimates for easy plotting with ggplot</span></span>
<span><span class="va">tidy_estimates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">S_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>daily_dose <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">daily_dose</span>, mu_hat <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">mu_hat</span>,</span>
<span>                     ub <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">mu_hat</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span> <span class="op">*</span> <span class="va">se</span>, lb <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">mu_hat</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span> <span class="op">*</span> <span class="va">se</span><span class="op">)</span></span>
<span>  <span class="va">tidy</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">tidy</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, <span class="va">tidy</span><span class="op">)</span> <span class="co"># duplicate placebo</span></span>
<span>  <span class="va">tidy</span><span class="op">$</span><span class="va">regimen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"od"</span>, <span class="st">"bid"</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"od"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">od</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"bid"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">bid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">tidy</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">plot_estimates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">tidy_estimates</span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">daily_dose</span>, <span class="va">mu_hat</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lb</span>, ymax <span class="op">=</span> <span class="va">ub</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">regimen</span><span class="op">)</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"daily dose"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"percent body weight cange"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"ANOVA estimates with 95% confindence intervals"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">est</span> <span class="op">&lt;-</span> <span class="fu">example_estimates</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="fu">plot_estimates</span><span class="op">(</span><span class="va">est</span><span class="op">)</span></span></code></pre></div>
<p><img src="mult_regimen_files/figure-html/data-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="candidate-models">Candidate models<a class="anchor" aria-label="anchor" href="#candidate-models"></a>
</h2>
<p>Even though not necessary and not always desired we will use the same
candidate models for both regimen here.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  od <span class="op">=</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>            sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>            maxEff <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>            doses <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">daily_dose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">od</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>  bid <span class="op">=</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>             sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">75</span>, <span class="fl">3.5</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">25</span>, <span class="fl">0.7</span><span class="op">)</span><span class="op">)</span>,</span>
<span>             maxEff <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>             doses<span class="op">=</span><span class="va">est</span><span class="op">$</span><span class="va">daily_dose</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">est</span><span class="op">$</span><span class="va">index</span><span class="op">$</span><span class="va">bid</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/Mods.html">plotMods</a></span><span class="op">(</span><span class="va">mods</span><span class="op">$</span><span class="va">od</span>, superpose <span class="op">=</span> <span class="cn">TRUE</span>, xlab <span class="op">=</span> <span class="st">"daily dose"</span><span class="op">)</span></span></code></pre></div>
<p><img src="mult_regimen_files/figure-html/candidate_models-1.png" width="85%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/Mods.html">plotMods</a></span><span class="op">(</span><span class="va">mods</span><span class="op">$</span><span class="va">bid</span>, superpose <span class="op">=</span> <span class="cn">TRUE</span>, xlab <span class="op">=</span> <span class="st">"daily dose"</span><span class="op">)</span></span></code></pre></div>
<p><img src="mult_regimen_files/figure-html/candidate_models-2.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="multiple-contrast-test">Multiple contrast test<a class="anchor" aria-label="anchor" href="#multiple-contrast-test"></a>
</h2>
<p>The matrix of contrasts is built up from a separate matrix for each
regimen. We stick them together in such a way that we compare <span class="math inline">\(\hat\mu_{\mathrm{od}}\)</span> and <span class="math inline">\(\hat\mu_{\mathrm{bid}}\)</span> with the common
placebo response estimate <span class="math inline">\(\hat\mu_{\mathrm{placebo}}\)</span>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calculate_contrasts</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est</span>, <span class="va">mods</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">S_hat</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">$</span><span class="va">S_hat</span></span>
<span>  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">est</span><span class="op">$</span><span class="va">index</span></span>
<span>  <span class="va">cm_od</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span><span class="va">mods</span><span class="op">$</span><span class="va">od</span>, S<span class="op">=</span><span class="va">S_hat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">i</span><span class="op">$</span><span class="va">od</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">i</span><span class="op">$</span><span class="va">od</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">contMat</span></span>
<span>  <span class="va">cm_bid</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span><span class="va">mods</span><span class="op">$</span><span class="va">bid</span>, S<span class="op">=</span><span class="va">S_hat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">i</span><span class="op">$</span><span class="va">bid</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">i</span><span class="op">$</span><span class="va">bid</span><span class="op">)</span><span class="op">]</span><span class="op">)</span><span class="op">$</span><span class="va">contMat</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"od_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"od_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bid_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"bid_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="co"># now build a block matrix (contrasts in columns) like this:</span></span>
<span>  <span class="co"># [ row of placebo coefficients od   | row of placebo coefficients bid   ]</span></span>
<span>  <span class="co"># [----------------------------------+-----------------------------------]</span></span>
<span>  <span class="co"># [ remaining doses' coefficents od  | fill with all zeros               ]</span></span>
<span>  <span class="co"># [----------------------------------+-----------------------------------]</span></span>
<span>  <span class="co"># [ fill with all zeros              | remaining doses' coefficients bid ]</span></span>
<span>  <span class="va">cm_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>    <span class="st">"0"</span><span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>,                                <span class="va">cm_bid</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span>                              <span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>,<span class="op">]</span>,                               <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">cm_bid</span><span class="op">)</span> <span class="op">-</span> <span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">cm_od</span><span class="op">)</span><span class="op">)</span>, <span class="va">cm_bid</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span>, <span class="op">]</span>                            <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">cm_full</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">cont_mat</span> <span class="op">&lt;-</span> <span class="fu">calculate_contrasts</span><span class="op">(</span><span class="va">est</span>, <span class="va">mods</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">cont_mat</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>        od_emax1 od_emax2 od_sigEmax1 od_sigEmax2 bid_emax1 bid_emax2
0           0.75     0.56        0.41        0.66      0.81      0.60
od_2.5      0.14     0.22        0.19        0.18      0.00      0.00
od_10      -0.08     0.13        0.20        0.03      0.00      0.00
od_50      -0.20    -0.13        0.06       -0.16      0.00      0.00
od_150     -0.61    -0.78       -0.87       -0.71      0.00      0.00
bid_5       0.00     0.00        0.00        0.00      0.04      0.21
bid_10      0.00     0.00        0.00        0.00     -0.08      0.13
bid_50      0.00     0.00        0.00        0.00     -0.24     -0.21
bid_100     0.00     0.00        0.00        0.00     -0.52     -0.73
        bid_sigEmax1 bid_sigEmax2
0               0.41         0.72
od_2.5          0.00         0.00
od_10           0.00         0.00
od_50           0.00         0.00
od_150          0.00         0.00
bid_5           0.21         0.12
bid_10          0.21         0.02
bid_50          0.02        -0.23
bid_100        -0.86        -0.64</code></pre>
<p>We also need to calculate the test statistics by hand.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mct_test</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">cont_mat</span>, <span class="va">est</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cont_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">cont_mat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">est</span><span class="op">$</span><span class="va">S_hat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">cont_mat</span></span>
<span>  <span class="va">t_stat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">mu_hat</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">cont_mat</span><span class="op">)</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">cont_cov</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co"># FIXME: calling non-exported function</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MCTpval.html">MCTpval</a></span><span class="op">(</span>contMat <span class="op">=</span> <span class="va">cont_mat</span>, corMat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov2cor</a></span><span class="op">(</span><span class="va">cont_cov</span><span class="op">)</span>,</span>
<span>               df<span class="op">=</span><span class="cn">Inf</span>, tStat<span class="op">=</span><span class="va">t_stat</span>, alternative <span class="op">=</span> <span class="st">"one.sided"</span><span class="op">)</span></span>
<span>  <span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">t_stat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>tStat <span class="op">=</span> <span class="va">t_stat</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>, pVals <span class="op">=</span> <span class="va">p</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">mct_test</span><span class="op">(</span><span class="va">cont_mat</span>, <span class="va">est</span><span class="op">)</span></span></code></pre></div>
<pre><code>                tStat        pVals
bid_sigEmax2 6.027666 1.669425e-09
bid_emax2    5.916858 3.346921e-09
bid_emax1    5.832739 5.574630e-09
od_sigEmax2  5.710927 1.151087e-08
od_emax2     5.640589 1.752113e-08
od_emax1     5.504042 6.425687e-08
od_sigEmax1  5.200171 2.689264e-07
bid_sigEmax1 5.006107 9.856002e-06</code></pre>
<p>A clear dose-response trend can be established for both regimen.</p>
</div>
<div class="section level2">
<h2 id="dose-response-modelling">Dose-response modelling<a class="anchor" aria-label="anchor" href="#dose-response-modelling"></a>
</h2>
<p>Dose-response estimation needs a handful of auxiliary functions. The
model for <span class="math inline">\(\hat\mu\)</span> has a common
intercept parameter for both regimen together and two sets of the
remaining parameters of the family in question. For example, a model
based on the Emax family has 5 parameters: one common <code>e0</code>,
<code>(eMax, ed50)</code> for the od regimen, and
<code>(eMax, ed50)</code> for the bid regimen.</p>
<p>The following function calculates the responses given dose values and
a model family.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate response under `model` for od/bid with common e0, but separate remaining parameters</span></span>
<span><span class="co">## arguments:</span></span>
<span><span class="co">## - model: as a string like "emax",</span></span>
<span><span class="co">## - i_par: list of vectors named "placebo", "od", "bid", used for indexing `par`</span></span>
<span><span class="co">## - par: numeric, model parameter structured as c(e0, pars_od, pars_bid)</span></span>
<span><span class="co">## returns: response at placebo, dose_od, dose_bid (in this order)</span></span>
<span><span class="va">eval_model_shared_e0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">dose_od</span>, <span class="va">dose_bid</span>, <span class="va">par</span>, <span class="va">i_par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">resp_placebo</span> <span class="op">&lt;-</span> <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="co"># e0</span></span>
<span>  <span class="va">resp_od</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dose_od</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="va">i_par</span><span class="op">$</span><span class="va">od</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">resp_bid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">dose_bid</span>, <span class="va">par</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="va">par</span><span class="op">[</span><span class="va">i_par</span><span class="op">$</span><span class="va">bid</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">resp_placebo</span>, <span class="va">resp_od</span>, <span class="va">resp_bid</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">resp</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Next, we need to be able to fit a model family to the observed <span class="math inline">\(\hat\mu\)</span>. For this we employ the usual
generalized MCP-Mod approach, i.e. generalized least squares with the
estimated covariance matrix <span class="math inline">\(\hat S\)</span>
<span class="citation">(<a href="#ref-pinheiro2014">Pinheiro et al.
2014</a>)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## find sensible starting values for `fit_model_shared_e0` by fitting separate models,</span></span>
<span><span class="co">## index:  list of vectors named "placebo", "od", "bid", used for indexing `dose`</span></span>
<span><span class="co">## bounds: passed through to `fitMod`</span></span>
<span><span class="va">calc_start_values</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">full_mu</span>, <span class="va">full_S</span>, <span class="va">dose</span>, <span class="va">index</span>, <span class="va">bounds</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">separate_coefs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"od"</span>, <span class="st">"bid"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">regimen</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">index</span><span class="op">$</span><span class="va">placebo</span>, <span class="va">index</span><span class="op">[[</span><span class="va">regimen</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="fu"><a href="../reference/fitMod.html">fitMod</a></span><span class="op">(</span><span class="va">dose</span><span class="op">[</span><span class="va">inds</span><span class="op">]</span>, <span class="va">full_mu</span><span class="op">[</span><span class="va">inds</span><span class="op">]</span>, S <span class="op">=</span> <span class="va">full_S</span><span class="op">[</span><span class="va">inds</span>, <span class="va">inds</span><span class="op">]</span>,</span>
<span>                type <span class="op">=</span> <span class="st">"general"</span>,  model <span class="op">=</span> <span class="va">model</span>, bnds <span class="op">=</span> <span class="va">bounds</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="co"># drop e0 estimate</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co">## remove names to prevent error in do.call() in eval_model_shared_e0;</span></span>
<span>  <span class="co">## od, bid coefs are in 1st / second column</span></span>
<span>  <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">full_mu</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">separate_coefs</span><span class="op">)</span>, use.names<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">start</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## fits 'model' to mu_hat with GLS (using S_hat_inv as weight matrix), using a common e0 for od and bid regimens.</span></span>
<span><span class="co">## i_reg:  list of vectors named "placebo", "od", "bid", used for indexing `dose`</span></span>
<span><span class="co">## i_par: passed through to `eval_model_shared_e0`</span></span>
<span><span class="co">## dose: numeric with doses for placebo, od, bid</span></span>
<span><span class="co">## lower, upper, start: control parameters fro `nlminb`</span></span>
<span><span class="va">fit_model_shared_e0</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">model</span>, <span class="va">dose</span>, <span class="va">mu_hat</span>, <span class="va">S_hat_inv</span>, <span class="va">lower</span>, <span class="va">upper</span>, <span class="va">start</span>, <span class="va">i_reg</span>, <span class="va">i_par</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">opt_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span><span class="op">)</span> <span class="op">{</span> <span class="co"># make use of lexical scope</span></span>
<span>    <span class="va">resp</span> <span class="op">&lt;-</span> <span class="fu">eval_model_shared_e0</span><span class="op">(</span><span class="va">model</span>, <span class="va">dose</span><span class="op">[</span><span class="va">i_reg</span><span class="op">$</span><span class="va">od</span><span class="op">]</span>, <span class="va">dose</span><span class="op">[</span><span class="va">i_reg</span><span class="op">$</span><span class="va">bid</span><span class="op">]</span>, <span class="va">par</span>, <span class="va">i_par</span><span class="op">)</span></span>
<span>    <span class="va">delta</span> <span class="op">&lt;-</span> <span class="va">resp</span> <span class="op">-</span> <span class="va">mu_hat</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">delta</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">S_hat_inv</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">delta</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></span><span class="op">(</span><span class="va">start</span>, <span class="va">opt_fun</span>, lower <span class="op">=</span> <span class="va">lower</span>, upper <span class="op">=</span> <span class="va">upper</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally, instead of only fitting a single model, we use the same
bootstrap-plus-averaging approach that is detailed in the <a href="analysis_normal.html#dose-response-estimation">vignette for
analysis of continuous data</a>.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## predict population response in each regimen for dose_seq_*</span></span>
<span><span class="co">## note: both dose_seq_* vectors should contain a 0 if response at placebo is of interest</span></span>
<span><span class="va">one_bootstrap_sample</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">est</span>, <span class="va">dose_seq_od</span>, <span class="va">dose_seq_bid</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">mu_new</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">est</span><span class="op">$</span><span class="va">mu_hat</span>, <span class="va">est</span><span class="op">$</span><span class="va">S_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">mod_info</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"emax"</span>, bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">225</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        i_par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>od <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">3</span>, bid <span class="op">=</span> <span class="fl">4</span><span class="op">:</span><span class="fl">5</span><span class="op">)</span>, n_par_gaic <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>,</span>
<span>                   <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"sigEmax"</span>, bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">225</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        i_par <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>od <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span>, bid <span class="op">=</span> <span class="fl">5</span><span class="op">:</span><span class="fl">7</span><span class="op">)</span>, n_par_gaic <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">mod_info</span>, <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">start</span> <span class="op">&lt;-</span> <span class="fu">calc_start_values</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">name</span>, <span class="va">mu_new</span>, <span class="va">est</span><span class="op">$</span><span class="va">S_hat</span>, <span class="va">est</span><span class="op">$</span><span class="va">daily_dose</span>, <span class="va">est</span><span class="op">$</span><span class="va">index</span>, <span class="va">m</span><span class="op">$</span><span class="va">bounds</span><span class="op">)</span></span>
<span>    <span class="va">low</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="cn">Inf</span>, <span class="op">-</span><span class="cn">Inf</span>, <span class="va">m</span><span class="op">$</span><span class="va">bounds</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co"># no bounds on e0, eMax</span></span>
<span>    <span class="va">up</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">Inf</span>, <span class="cn">Inf</span>, <span class="va">m</span><span class="op">$</span><span class="va">bounds</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="fu">fit_model_shared_e0</span><span class="op">(</span><span class="va">m</span><span class="op">$</span><span class="va">name</span>, <span class="va">est</span><span class="op">$</span><span class="va">daily_dose</span>, <span class="va">mu_new</span>, <span class="fu"><a href="https://rdrr.io/r/base/solve.html" class="external-link">solve</a></span><span class="op">(</span><span class="va">est</span><span class="op">$</span><span class="va">S_hat</span><span class="op">)</span>, lower <span class="op">=</span> <span class="va">low</span>,  upper <span class="op">=</span> <span class="va">up</span>,</span>
<span>                        start <span class="op">=</span> <span class="va">start</span>, i_reg <span class="op">=</span> <span class="va">est</span><span class="op">$</span><span class="va">index</span>, i_par <span class="op">=</span> <span class="va">m</span><span class="op">$</span><span class="va">i_par</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="co">## calculate gAICs</span></span>
<span>  <span class="va">gaics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">`[[`</span>, <span class="st">"objective"</span><span class="op">)</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">mod_info</span>, <span class="va">`[[`</span>, <span class="st">"n_par_gaic"</span><span class="op">)</span></span>
<span>  <span class="va">sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="va">gaics</span><span class="op">)</span></span>
<span>  <span class="va">mod</span> <span class="op">&lt;-</span> <span class="va">mod_info</span><span class="op">[[</span><span class="va">sel</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="co">## drop the placebo element</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu">eval_model_shared_e0</span><span class="op">(</span><span class="va">mod</span><span class="op">$</span><span class="va">name</span>, <span class="va">dose_seq_od</span>, <span class="va">dose_seq_bid</span>, <span class="va">fit</span><span class="op">[[</span><span class="va">sel</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">par</span>, <span class="va">mod</span><span class="op">$</span><span class="va">i_par</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">summarize_bootstrap_samples</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">samples</span>, <span class="va">probs</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="fl">1</span>, <span class="va">median</span><span class="op">)</span></span>
<span>  <span class="va">quants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">samples</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="va">probs</span><span class="op">)</span></span>
<span>  <span class="va">bs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">med</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">quants</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bs_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"median"</span>, <span class="st">"low_out"</span>, <span class="st">"low_in"</span>, <span class="st">"high_in"</span>, <span class="st">"high_out"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">bs_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">dose_seq_od</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">150</span>, length.out <span class="op">=</span> <span class="fl">21</span><span class="op">)</span> <span class="co"># do include placebo!</span></span>
<span><span class="va">dose_seq_bid</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">100</span>, length.out <span class="op">=</span> <span class="fl">21</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span>, kind <span class="op">=</span> <span class="st">"Mersenne-Twister"</span>, sample.kind <span class="op">=</span> <span class="st">"Rejection"</span>, normal.kind <span class="op">=</span> <span class="st">"Inversion"</span><span class="op">)</span></span>
<span><span class="va">reps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fu">one_bootstrap_sample</span><span class="op">(</span><span class="va">est</span>, <span class="va">dose_seq_od</span>, <span class="va">dose_seq_bid</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">bs_sum</span> <span class="op">&lt;-</span> <span class="fu">summarize_bootstrap_samples</span><span class="op">(</span><span class="va">reps</span><span class="op">)</span></span>
<span><span class="va">bs_sum</span><span class="op">$</span><span class="va">daily_dose</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">dose_seq_od</span>, <span class="va">dose_seq_bid</span><span class="op">)</span></span>
<span><span class="va">bs_sum</span><span class="op">$</span><span class="va">regimen</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"od"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dose_seq_od</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"bid"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dose_seq_bid</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">bs_sum</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">daily_dose</span>, ymin<span class="op">=</span><span class="va">low_out</span>, ymax<span class="op">=</span><span class="va">high_out</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">daily_dose</span>, ymin<span class="op">=</span><span class="va">low_in</span>, ymax<span class="op">=</span><span class="va">high_in</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">daily_dose</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">daily_dose</span>, <span class="va">mu_hat</span><span class="op">)</span>, <span class="fu">tidy_estimates</span><span class="op">(</span><span class="va">est</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">regimen</span><span class="op">)</span>, labeller <span class="op">=</span> <span class="va">label_both</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Bootstrap estimates for population response"</span>,</span>
<span>       subtitle <span class="op">=</span> <span class="st">"Least squares estimates plus 50% and 95% confidence bands"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"daily dose"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"percent body weigh change"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="mult_regimen_files/figure-html/estimation_3-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bays2020" class="csl-entry">
Bays, H. E., Kozlovski, P., Shao, Q., Proot, P., and Keefe, D. (2020),
<span>“Licogliflozin, a novel SGLT1 and 2 inhibitor: Body weight effects
in a randomized trial in adults with overweight or obesity,”</span>
<em>Obesity</em>, 28, 870–881. <a href="https://doi.org/10.1002/oby.22764" class="external-link">https://doi.org/10.1002/oby.22764</a>.
</div>
<div id="ref-pinheiro2014" class="csl-entry">
Pinheiro, J., Bornkamp, B., Glimm, E., and Bretz, F. (2014),
<span>“Model-based dose finding under model uncertainty using general
parametric models,”</span> <em>Statistics in Medicine</em>, 33,
1646–1661. <a href="https://doi.org/10.1002/sim.6052" class="external-link">https://doi.org/10.1002/sim.6052</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Bornkamp, Jose Pinheiro, Frank Bretz, Ludger Sandig, Marius Thomas, Novartis Pharma AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
