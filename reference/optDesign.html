<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Function to calculate optimal designs — optDesign • DoseFinding</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Function to calculate optimal designs — optDesign"><meta name="description" content="Given a set of models (with full parameter values and model probabilities) the optDesign function calculates
the optimal design for estimating the dose-response model parameters (D-optimal) or the design for estimating the
target dose (TD-optimal design) (see Dette, Bretz, Pepelyshev and Pinheiro (2008)), or a mixture of these two
criteria. The design can be plotted (together with the candidate models) using plot.design. calcCrit
calculates the design criterion for a discrete set of design(s). rndDesign provides efficient rounding for the
calculated continous design to a finite sample size."><meta property="og:description" content="Given a set of models (with full parameter values and model probabilities) the optDesign function calculates
the optimal design for estimating the dose-response model parameters (D-optimal) or the design for estimating the
target dose (TD-optimal design) (see Dette, Bretz, Pepelyshev and Pinheiro (2008)), or a mixture of these two
criteria. The design can be plotted (together with the candidate models) using plot.design. calcCrit
calculates the design criterion for a discrete set of design(s). rndDesign provides efficient rounding for the
calculated continous design to a finite sample size."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DoseFinding</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3-1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/analysis_normal.html">Continuous data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/binary_data.html">Binary Data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">MCP-Mod FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/mult_regimen.html">Multiple Regimen MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/overview.html">Overview DoseFinding package</a></li>
    <li><a class="dropdown-item" href="../articles/sample_size.html">Sample size calculations for MCP-Mod</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/DoseFinding/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Function to calculate optimal designs</h1>
      <small class="dont-index">Source: <a href="https://github.com/openpharma/DoseFinding/blob/master/R/optDesign.R" class="external-link"><code>R/optDesign.R</code></a></small>
      <div class="d-none name"><code>optDesign.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Given a set of models (with full parameter values and model probabilities) the <samp>optDesign</samp> function calculates
the optimal design for estimating the dose-response model parameters (D-optimal) or the design for estimating the
target dose (TD-optimal design) (see Dette, Bretz, Pepelyshev and Pinheiro (2008)), or a mixture of these two
criteria. The design can be plotted (together with the candidate models) using <samp>plot.design</samp>. <samp>calcCrit</samp>
calculates the design criterion for a discrete set of design(s). <samp>rndDesign</samp> provides efficient rounding for the
calculated continous design to a finite sample size.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">optDesign</span><span class="op">(</span></span>
<span>  <span class="va">models</span>,</span>
<span>  <span class="va">probs</span>,</span>
<span>  <span class="va">doses</span>,</span>
<span>  designCrit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dopt"</span>, <span class="st">"TD"</span>, <span class="st">"Dopt&amp;TD"</span>, <span class="st">"userCrit"</span><span class="op">)</span>,</span>
<span>  <span class="va">Delta</span>,</span>
<span>  standDopt <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">weights</span>,</span>
<span>  nold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">n</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  optimizer <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"solnp"</span>, <span class="st">"Nelder-Mead"</span>, <span class="st">"nlminb"</span>, <span class="st">"exact"</span><span class="op">)</span>,</span>
<span>  lowbnd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  uppbnd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">userCrit</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">calcCrit</span><span class="op">(</span></span>
<span>  <span class="va">design</span>,</span>
<span>  <span class="va">models</span>,</span>
<span>  <span class="va">probs</span>,</span>
<span>  <span class="va">doses</span>,</span>
<span>  designCrit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Dopt"</span>, <span class="st">"TD"</span>, <span class="st">"Dopt&amp;TD"</span><span class="op">)</span>,</span>
<span>  <span class="va">Delta</span>,</span>
<span>  standDopt <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  <span class="va">weights</span>,</span>
<span>  nold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="va">n</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">rndDesign</span><span class="op">(</span><span class="va">design</span>, <span class="va">n</span>, eps <span class="op">=</span> <span class="fl">1e-04</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># S3 method for class 'DRdesign'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">models</span>, lwdDes <span class="op">=</span> <span class="fl">10</span>, colDes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grDevices/rgb.html" class="external-link">rgb</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0</span>, <span class="fl">0.3</span><span class="op">)</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-models">models<a class="anchor" aria-label="anchor" href="#arg-models"></a></dt>
<dd><p>An object of class <samp>c(Mods, fullMod)</samp>, see the <code><a href="Mods.html">Mods</a></code> function for details. When an TD
optimal design should be calculated, the TD needs to exist for all models. If a D-optimal design should be
calculated, you need at least as many doses as there are parameters in the specified models.</p></dd>


<dt id="arg-probs">probs<a class="anchor" aria-label="anchor" href="#arg-probs"></a></dt>
<dd><p>Vector of model probabilities for the models specified in <samp>models</samp>, assumed in the same order as
specified in models</p></dd>


<dt id="arg-doses">doses<a class="anchor" aria-label="anchor" href="#arg-doses"></a></dt>
<dd><p>Optional argument. If this argument is missing the doses attribute in the <samp>c(Mods, fullMod)</samp> object
specified in <samp>models</samp> is used.</p></dd>


<dt id="arg-designcrit">designCrit<a class="anchor" aria-label="anchor" href="#arg-designcrit"></a></dt>
<dd><p>Determines which type of design to calculate. "TD&amp;Dopt" uses both optimality criteria with equal
weight.</p></dd>


<dt id="arg-delta">Delta<a class="anchor" aria-label="anchor" href="#arg-delta"></a></dt>
<dd><p>Target effect needed for calculating "TD" and "TD&amp;Dopt" type designs.</p></dd>


<dt id="arg-standdopt">standDopt<a class="anchor" aria-label="anchor" href="#arg-standdopt"></a></dt>
<dd><p>Logical determining, whether the D-optimality criterion (specifically the log-determinant) should be
standardized by the number of parameters in the model or not (only of interest if type = "Dopt" or type =
"TD&amp;Dopt"). This is of interest, when there is more than one model class in the candidate model set (traditionally
standardization this is done in the optimal design literature).</p></dd>


<dt id="arg-weights">weights<a class="anchor" aria-label="anchor" href="#arg-weights"></a></dt>
<dd><p>Vector of weights associated with the response at the doses. Needs to be of the same length as the
<samp>doses</samp>.  This can be used to calculate designs for heteroscedastic or for generalized linear model
situations.</p></dd>


<dt id="arg-nold-n">nold, n<a class="anchor" aria-label="anchor" href="#arg-nold-n"></a></dt>
<dd><p>When calculating an optimal design at an interim analysis, <samp>nold</samp> specifies the vector of sample
  sizes already allocated to the different doses, and <samp>n</samp> gives sample size for the next cohort.</p>
<p>For <samp>optimizer = "exact"</samp> one always needs to specify the total sample size via <samp>n</samp>.</p></dd>


<dt id="arg-control">control<a class="anchor" aria-label="anchor" href="#arg-control"></a></dt>
<dd><p>List containing control parameters passed down to numerical optimization algorithms
  (<code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code>, <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code> or solnp function).<br></p>
<p>For <samp>type = "exact"</samp> this should be a list with possible entries <samp>maxvls1</samp> and <samp>maxvls2</samp>,
  determining the maximum number of designs allowed for passing to the criterion function (default
  <samp>maxvls2=1e5</samp>) and for creating the initial unrestricted matrix of designs (default <samp>maxvls1=1e6</samp>). In
  addition there can be an entry <samp>groupSize</samp> in case the patients are allocated a minimum group size is
  required.</p></dd>


<dt id="arg-optimizer">optimizer<a class="anchor" aria-label="anchor" href="#arg-optimizer"></a></dt>
<dd><p>Algorithm used for calculating the optimal design. Options "Nelder-Mead" and "nlminb" use the
  <code><a href="https://rdrr.io/r/stats/optim.html" class="external-link">optim</a></code> and <code><a href="https://rdrr.io/r/stats/nlminb.html" class="external-link">nlminb</a></code> function and use a trigonometric transformation to turn the
  constrained optimization problem into an unconstrained one (see Atkinson, Donev and Tobias, 2007, pages 130,131).</p>
<p>Option "solnp" uses the solnp function from the Rsolnp package, which implements an optimizer for non-linear
  optimization under general constraints.</p>
<p>Option "exact" tries all given combinations of <samp>n</samp> patients to the given dose groups (subject to the bounds
  specified via <samp>lowbnd</samp> and <samp>uppbnd</samp>) and reports the best design. When patients are only allowed to be
  allocated in groups of a certain <samp>groupSize</samp>, this can be adjusted via the control argument.
  <samp>n/groupSize</samp> and <samp>length(doses)</samp> should be rather small for this approach to be feasible.</p>
<p>When the number of doses is small (&lt;8) usually <samp>"Nelder-Mead"</samp> and <samp>"nlminb"</samp> are best suited
  (<samp>"nlminb"</samp> is usually a bit faster but less stable than <samp>"Nelder-Mead"</samp>). For a larger number of doses
  <samp>"solnp"</samp> is the most reliable option (but also slowest) (<samp>"Nelder-Mead"</samp> and <samp>"nlminb"</samp> often
  fail). When the sample size is small <samp>"exact"</samp> provides the optimal solution rather quickly.</p></dd>


<dt id="arg-lowbnd-uppbnd">lowbnd, uppbnd<a class="anchor" aria-label="anchor" href="#arg-lowbnd-uppbnd"></a></dt>
<dd><p>Vectors of the same length as dose vector specifying upper and lower limits for the allocation
weights. This option is only available when using the "solnp" and "exact" optimizers.</p></dd>


<dt id="arg-usercrit">userCrit<a class="anchor" aria-label="anchor" href="#arg-usercrit"></a></dt>
<dd><p>User defined design criterion, should be a function that given a vector of allocation weights and the
  doses returns the criterion function. When specified <samp>models</samp> does not need to be handed over.</p>
<p>The first argument of <samp>userCrit</samp> should be the vector of design weights, while the second argument should be
  the <samp>doses</samp> argument (see example below). Additional arguments to <samp>userCrit</samp> can be passed via ...</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>For function <samp>optDesign</samp> these are additional arguments passed to <samp>userCrit</samp>.<br><br> For
function <samp>plot.design</samp> these are additional parameters passed to <code><a href="Mods.html">plot.Mods</a></code>.<br></p></dd>


<dt id="arg-design">design<a class="anchor" aria-label="anchor" href="#arg-design"></a></dt>
<dd><p>Argument for <samp>rndDesign</samp> and <samp>calcCrit</samp> functions: Numeric vector (or matrix) of allocation
weights for the different doses. The rows of the matrices need to sum to 1. Alternatively also an object of class
"DRdesign" can be used for <samp>rndDesign</samp>. Note that there should be at least as many design points available as
there are parameters in the dose-response models selected in <code>models</code> (otherwise the code returns an NA).</p></dd>


<dt id="arg-eps">eps<a class="anchor" aria-label="anchor" href="#arg-eps"></a></dt>
<dd><p>Argument for <samp>rndDesign</samp> function: Value under which elements of w will be regarded as 0.</p></dd>


<dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>Object of class <samp>DRdesign</samp> (for <samp>plot.design</samp>)</p></dd>


<dt id="arg-lwddes-coldes">lwdDes, colDes<a class="anchor" aria-label="anchor" href="#arg-lwddes-coldes"></a></dt>
<dd><p>Line width and color of the lines plotted for the design (in <samp>plot.design</samp>)</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>Let \(M_m\) denote the Fisher information matrix under model m (up to
proportionality). \(M_m\) is given by \(\sum a_i w_i \)\( g_i^Tg_i\), where \(a_i\) is
the allocation weight to dose i, \(w_i\) the weight for dose i specified via <samp>weights</samp> and \(g_i\)
the gradient vector of model m evaluated at dose i.</p>
<p>For <samp>designCrit = "Dopt"</samp> the code minimizes the design criterion</p>
<p>$$-\sum_{m}p_m/k_m \log(\det(M_m))$$ where \(p_m\) is the probability for
model m and \(k_m\) is the number of parameters for model m. When <samp>standDopt = FALSE</samp> the \(k_m\)
are all assumed to be equal to one.</p>
<p>For <samp>designCrit = "TD"</samp> the code minimizes the design criterion</p>
<p>$$\sum_{m}p_m \log(v_m)$$ where \(p_m\) is the probability for model m and
\(v_m\) is proportional to the asymptotic
variance of the TD estimate and given by \(b_m'M_m^{-}b_m\) (see Dette et al. (2008), p. 1227 for details).</p>
<p>For <samp>designCrit = "Dopt&amp;TD"</samp> the code minimizes the design criterion
$$\sum_{m}p_m(-0.5\log(\det(M_m))/k_m+0.5\log(v_m))$$</p>
<p>Again, for <samp>standDopt = FALSE</samp> the \(k_m\) are all assumed to be equal to one.</p>
<p>For details on the <samp>rndDesign</samp> function, see Pukelsheim (1993), Chapter 12.</p>
    </div>
    <div class="section level2">
    <h2 id="note">Note<a class="anchor" aria-label="anchor" href="#note"></a></h2>
    <p>In some cases (particularly when the number of doses is large, e.g. 7 or larger) it might be necessary to allow
  a larger number of iterations in the algorithm (via the argument <samp>control</samp>), particularly for the Nelder-Mead
  algorithm. Alternatively one can use the solnp optimizer that is usually the most reliable, but not fastest option.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Atkinson, A.C., Donev, A.N. and Tobias, R.D. (2007). Optimum Experimental Designs, with SAS, Oxford
  University Press</p>
<p>Dette, H., Bretz, F., Pepelyshev, A. and Pinheiro, J. C. (2008). Optimal
Designs for Dose Finding Studies, <em>Journal of the American Statisical
Association</em>, <b>103</b>, 1225–1237</p>
<p>Pinheiro, J.C., Bornkamp, B. (2017) Designing Phase II Dose-Finding Studies: Sample Size, Doses and Dose Allocation
  Weights, in O'Quigley, J., Iasonos, A. and Bornkamp, B. (eds) Handbook of methods for designing, monitoring, and
  analyzing dose-finding trials, CRC press</p>
<p>Pukelsheim, F. (1993). Optimal Design of Experiments, Wiley</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="Mods.html">Mods</a></code>, <code><a href="drmodels.html">drmodels</a></code></p></div>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Bjoern Bornkamp</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## calculate designs for Emax model</span></span></span>
<span class="r-in"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">emodel</span> <span class="op">&lt;-</span> <span class="fu"><a href="Mods.html">Mods</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fl">15</span>, doses<span class="op">=</span><span class="va">doses</span>, placEff <span class="op">=</span> <span class="fl">0</span>, maxEff <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated D - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.33333 0.33333 0.33333 </span>
<span class="r-in"><span><span class="co">## TD-optimal design</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs <span class="op">=</span> <span class="fl">1</span>, designCrit <span class="op">=</span> <span class="st">"TD"</span>, Delta<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated TD - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.50000 0.48225 0.01775 </span>
<span class="r-in"><span><span class="co">## 50-50 mixture of Dopt and TD</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs <span class="op">=</span> <span class="fl">1</span>, designCrit <span class="op">=</span> <span class="st">"Dopt&amp;TD"</span>, Delta<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated TD and D mixture - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.42190 0.41062 0.16748 </span>
<span class="r-in"><span><span class="co">## use dose levels different from the ones specified in emodel object</span></span></span>
<span class="r-in"><span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs <span class="op">=</span> <span class="fl">1</span>, doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span>, <span class="fl">20</span>, <span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## plot models overlaid by design</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">des</span>, <span class="va">emodel</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="optDesign-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span><span class="co">## round des to a sample size of exactly 90 patients</span></span></span>
<span class="r-in"><span><span class="fu">rndDesign</span><span class="op">(</span><span class="va">des</span>, n<span class="op">=</span><span class="fl">90</span><span class="op">)</span> <span class="co">## using the round function would lead to 91 patients</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 29  6 26 29</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## illustrating different optimizers (see Note above for more comparison)</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs<span class="op">=</span><span class="fl">1</span>, optimizer<span class="op">=</span><span class="st">"Nelder-Mead"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated D - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.33333 0.33333 0.33333 </span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs<span class="op">=</span><span class="fl">1</span>, optimizer<span class="op">=</span><span class="st">"nlminb"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated D - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.33333 0.33333 0.33333 </span>
<span class="r-in"><span><span class="co">## optimizer solnp (the default) can deal with lower and upper bounds:</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs<span class="op">=</span><span class="fl">1</span>, designCrit <span class="op">=</span> <span class="st">"TD"</span>, Delta<span class="op">=</span><span class="fl">0.5</span>,</span></span>
<span class="r-in"><span>          optimizer<span class="op">=</span><span class="st">"solnp"</span>, lowbnd <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0.2</span>,<span class="fl">3</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated TD - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.40723 0.39277 0.20000 </span>
<span class="r-in"><span><span class="co">## exact design using enumeration of all possibilites</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs<span class="op">=</span><span class="fl">1</span>, optimizer<span class="op">=</span><span class="st">"exact"</span>, n <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated D - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.33333 0.33333 0.33333 </span>
<span class="r-in"><span><span class="co">## also allows to fix minimum groupSize</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, probs<span class="op">=</span><span class="fl">1</span>, designCrit <span class="op">=</span> <span class="st">"TD"</span>, Delta<span class="op">=</span><span class="fl">0.5</span>,</span></span>
<span class="r-in"><span>          optimizer<span class="op">=</span><span class="st">"exact"</span>, n <span class="op">=</span> <span class="fl">30</span>,  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>groupSize<span class="op">=</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated TD - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10     100 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.50000 0.33333 0.16667 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## optimal design at interim analysis</span></span></span>
<span class="r-in"><span><span class="co">## assume there are already 10 patients on each dose and there are 30</span></span></span>
<span class="r-in"><span><span class="co">## left to randomize, this calculates the optimal increment design</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span><span class="va">emodel</span>, <span class="fl">1</span>, designCrit <span class="op">=</span> <span class="st">"TD"</span>, Delta<span class="op">=</span><span class="fl">0.5</span>,</span></span>
<span class="r-in"><span>          nold <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>, n<span class="op">=</span><span class="fl">30</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated TD - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       0      10 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.51506 0.48494 </span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## use a larger candidate model set</span></span></span>
<span class="r-in"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">150</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fmods</span> <span class="op">&lt;-</span> <span class="fu"><a href="Mods.html">Mods</a></span><span class="op">(</span>linear <span class="op">=</span> <span class="cn">NULL</span>, emax <span class="op">=</span> <span class="fl">25</span>, exponential <span class="op">=</span> <span class="fl">85</span>,</span></span>
<span class="r-in"><span>             linlog <span class="op">=</span> <span class="cn">NULL</span>, logistic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">50</span>, <span class="fl">10.8811</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             doses <span class="op">=</span> <span class="va">doses</span>, addArgs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>off<span class="op">=</span><span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>             placEff<span class="op">=</span><span class="fl">0</span>, maxEff<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">5</span>, <span class="fl">5</span><span class="op">)</span> <span class="co"># assume uniform prior</span></span></span>
<span class="r-in"><span><span class="va">desDopt</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">fmods</span>, <span class="va">probs</span>, optimizer <span class="op">=</span> <span class="st">"nlminb"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">desTD</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">fmods</span>, <span class="va">probs</span>, designCrit <span class="op">=</span> <span class="st">"TD"</span>, Delta <span class="op">=</span> <span class="fl">0.2</span>,</span></span>
<span class="r-in"><span>                   optimizer <span class="op">=</span> <span class="st">"nlminb"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">desMix</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">fmods</span>, <span class="va">probs</span>, designCrit <span class="op">=</span> <span class="st">"Dopt&amp;TD"</span>, Delta <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## plot design and truth</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">desMix</span>, <span class="va">fmods</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="optDesign-2.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## illustrate calcCrit function</span></span></span>
<span class="r-in"><span><span class="co">## calculate optimal design for beta model</span></span></span>
<span class="r-in"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.49</span>, <span class="fl">25.2</span>, <span class="fl">108.07</span>, <span class="fl">150</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="Mods.html">Mods</a></span><span class="op">(</span>betaMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.33</span>, <span class="fl">2.31</span><span class="op">)</span>, doses<span class="op">=</span><span class="va">doses</span>,</span></span>
<span class="r-in"><span>                addArgs<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>scal<span class="op">=</span><span class="fl">200</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                placEff<span class="op">=</span><span class="fl">0</span>, maxEff<span class="op">=</span><span class="fl">0.4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">probs</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></span>
<span class="r-in"><span><span class="va">deswgts</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">models</span>, <span class="va">probs</span>, designCrit <span class="op">=</span> <span class="st">"Dopt"</span>,</span></span>
<span class="r-in"><span>                     control<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>maxit<span class="op">=</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## now compare this design to equal allocations on</span></span></span>
<span class="r-in"><span><span class="co">## 0, 10, 25, 50, 100, 150</span></span></span>
<span class="r-in"><span><span class="va">doses2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">150</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">design2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">6</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">6</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">crit2</span> <span class="op">&lt;-</span> <span class="fu">calcCrit</span><span class="op">(</span><span class="va">design2</span>, <span class="va">models</span>, <span class="va">probs</span>, <span class="va">doses2</span>, designCrit <span class="op">=</span> <span class="st">"Dopt"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## ratio of determinants (returned criterion value is on log scale)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">deswgts</span><span class="op">$</span><span class="va">crit</span><span class="op">-</span><span class="va">crit2</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 0.677752</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## example for calculating an optimal design for logistic regression</span></span></span>
<span class="r-in"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.35</span>, <span class="fl">0.5</span>, <span class="fl">0.65</span>, <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fMod</span> <span class="op">&lt;-</span> <span class="fu"><a href="Mods.html">Mods</a></span><span class="op">(</span>linear <span class="op">=</span> <span class="cn">NULL</span>, doses<span class="op">=</span><span class="va">doses</span>, placEff<span class="op">=</span><span class="op">-</span><span class="fl">5</span>, maxEff <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co">## now calculate weights to use in the covariance matrix</span></span></span>
<span class="r-in"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="Mods.html">getResp</a></span><span class="op">(</span><span class="va">fMod</span>, doses<span class="op">=</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">mu</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">mu</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">weights</span> <span class="op">&lt;-</span> <span class="va">mu</span><span class="op">*</span><span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">mu</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">des</span> <span class="op">&lt;-</span> <span class="fu">optDesign</span><span class="op">(</span><span class="va">fMod</span>, <span class="fl">1</span>, <span class="va">doses</span>, weights <span class="op">=</span> <span class="va">weights</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## one can also specify a user defined criterion function</span></span></span>
<span class="r-in"><span><span class="co">## here D-optimality for cubic polynomial</span></span></span>
<span class="r-in"><span><span class="va">CubeCrit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">w</span>, <span class="va">doses</span><span class="op">)</span><span class="op">{</span></span></span>
<span class="r-in"><span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">doses</span>, <span class="va">doses</span><span class="op">^</span><span class="fl">2</span>, <span class="va">doses</span><span class="op">^</span><span class="fl">3</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="va">CVinv</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/crossprod.html" class="external-link">crossprod</a></span><span class="op">(</span><span class="va">X</span><span class="op">*</span><span class="va">w</span><span class="op">)</span></span></span>
<span class="r-in"><span>  <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">CVinv</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span></span></span>
<span class="r-in"><span><span class="fu">optDesign</span><span class="op">(</span>doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.05</span>,<span class="fl">0.2</span>,<span class="fl">0.6</span>,<span class="fl">1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>          designCrit <span class="op">=</span> <span class="st">"userCrit"</span>, userCrit <span class="op">=</span> <span class="va">CubeCrit</span>,</span></span>
<span class="r-in"><span>          optimizer <span class="op">=</span> <span class="st">"nlminb"</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> Calculated userCrit - optimal design:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    0  0.2  0.6    1 </span>
<span class="r-out co"><span class="r-pr">#&gt;</span> 0.25 0.25 0.25 0.25 </span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Bornkamp, Jose Pinheiro, Frank Bretz, Ludger Sandig, Marius Thomas, Novartis Pharma AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer></div>





  </body></html>

