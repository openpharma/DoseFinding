---
title: "Part 2 - After Data Generation"
author: "Carina Miller"
date: "2025-07-04"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(truncnorm)
library(dplyr)
library(survival)
library(ggsurvfit)
library(DoseFinding, lib.loc = "~/RStudio/packages")
library(ggplot2)
```

```{r}
# Data generation
```{r}
set.seed(2026)
n <- 10000 # number of patients
etotal <- 5000 # predefined number of events
# simulate data based on the hazards of the second Emax model
mean_resp <- sample(y[, 2], n, replace = T, prob = c(2 / 7, 1 / 7, 1 / 7, 3 / 7)) # true mean response for each dose
# table(mean_resp) # control
ms_type <- sample(c(1, 2), n, replace = T, prob = c(0.45, 0.55)) # 1 = PPMS, 2 = SPMS # here: does not influence survival time


# Simulate survival data using an exponential distribution with the true hazard rates (mean_resp)
t <- rexp(length(mean_resp), exp(mean_resp)) # Simulate survival data from exponential with some beta's
# plot(t) # control
t_max_event <- sort(t)[etotal] # this is the time cutoff when etotal of event being observed
cens <- rep(t_max_event, length(mean_resp)) # censor after etotal events
u <- pmin(cens, t) # time is minimum of event time and censoring time
status <- (t <= cens) # status 1 if person had event, 0 if person git censored
data <- data.frame(
    group = names(mean_resp), # doses
    hazard = mean_resp,
    time = u,
    status = as.numeric(status),
    ms_type = ms_type)
# table(data$group)
# table(data$status)
head(data)
```


```{r}
# fit <- survfit(Surv(time, status) ~ 1, data = data)
# plot(
#   fit,
#   conf.int = T,
#   main = "Kaplan-Meier Estimator with CI",
#   xlab = "Time (years)",
#   ylab = "Survival",
#   col = "blue"
# )

survfit2(Surv(time, status) ~ 1, data = data) %>%
  ggsurvfit() +
  labs(x = "Years",
       y = "Probability",
       title = "Kaplan-Meier Estimator") +
  add_confidence_interval() +
  add_risktable() +
  theme(plot.title = element_text(hjust = 0.5))


survfit2(Surv(time, status) ~ group, data = data) %>%
  ggsurvfit() +
  labs(x = "Years",
       y = "Probability",
       title = "Kaplan-Meier Estimator by Dose") +
  theme(plot.title = element_text(hjust = 0.5))

survfit2(Surv(time, status) ~ ms_type, data = data) %>%
  ggsurvfit() +
  labs(
    x = "Years",
    y = "Probability",
    title = "Kaplan-Meier Estimator by Illness Type"
    ) +
  theme(plot.title=element_text(hjust=0.5))
```

```{r}
# run Cox PH Model
# Fit the Cox Proportional Hazards model to the survival data. Evaluate whether the treatment has a significant effect on survival:
cox <- coxph(Surv(time, status) ~ group, data = data)
summary(cox)
```
When predictors are significant and negative, this suggests a linear decreasing trend across dose.

Covariance matrix of the Cox model:
```{r}
coef <- cox$coef # 1st column of summary; Contains the estimated log hazard ratios for each dose group (relative to the reference group, typically placebo); estimates
cov <- cox$var # variance-covariance matrix of the estimated coefficients from the Cox Proportional Hazards Model
# same with
# cov <- vcov(cox)
cov
```

# Multiple Contrast Test
```{r}
doses_treat <- doses[-1] # remove placebo, everything placebo adjusted!
# Evaluate dose-response relationships using the MCPMod approach. Tests for significant differences across doses
mct <-
  MCTtest(
    dose = doses_treat,
    resp = coef,
    S = cov,
    models = mods,
    type = 'general',
    alternative = "one.sided",
    placAdj = TRUE # placebo-adjusted estimates are specified in ‘⁠resp⁠’
  )
mct
```
How well do the different potential dose-response models fit the data compared to the null hypothesis $H_0$: "no dose-response relationship"?/

First table: how much weight does each dose contribute to the test for each hypothesized model?/
(like book p.220 Table 12.3) contains optimal contrasts for candidate shapes./

Second table: how similar or related are the estimated contrasts for each model?/
High correlations (near 1) between models (e.g., emax1 and emax2) suggest these models produce similar dose-response patterns./
(like book p.220 Table 12.4 or p.222 Table 12.6) contains result of the contrast test. Here, all adjusted p-values are small, so this gives a strong evidence for the existence of a dose-response effect./

Third table: t-statistics and adjusted p-values for each model/
how strong is the evidence for the corresponding model?/
A higher t-statistic suggests better compatibility between the model and the observed data./
Smaller adjusted p-values ($< 0.05$) indicate strong evidence for the model fitting better than the null hypothesis ("no dose-response relationship")./

Model with smallest p-value and highest t-stat is  the best model, with the strongest statistical evidence for detecting the dose-response pattern


# Find the best model (see book p. 219)
Plot of estimated dose-response curve (book p. 220)/
Like plot in book p.221, Fig 12.2
```{r}
fitEmax <- fitMod(
  dose = doses_treat,
  resp = coef,
  S = cov,
  model = 'emax',
  type = 'general',
  placAdj = TRUE
)
# TODO: Warum ist es wichtig, dass man placebo adjusted wählt? Was macht das für einen Unterschied?
plot(fitEmax)
# plot(fitEmax, plotData = 'meansCI', CI = T, level = 0.95) ?
aic_emax <- gAIC(fitEmax)
# TODO: Bei AIC erhält man einen Error: use method gAIC for type == "general" --> Begründen, warum man hier also gAIC braucht!!!

fitSigEmax <- fitMod(
  dose = doses_treat,
  resp = coef,
  S = cov,
  model = 'sigEmax',
  type = 'general',
  placAdj = TRUE
)

plot(fitSigEmax)
# plot(fitSigEmax, plotData = 'meansCI', CI = T, level = 0.95)
aic_sigemax <- gAIC(fitSigEmax) 

ifelse(aic_emax <= aic_sigemax, 
       paste('Emax model fits better than SigEmax regarding the gAIC values of the models.'),
       paste('SigEmax model fits better than Emax regarding the gAIC values of the models.'))
```
Preferred model is the one with the minimum AIC value./

# Find the best dose (see book p. 220)
Here, decreasing response is beneficial (as before)./ 
Find a dose that achieves a certain percentage of the full effect size, usually $0.9$ as it is close to the plateau.
```{r}
percentage_dose_sigemax <- ED(fitEmax, p = 0.9, direction = 'decreasing')
percentage_dose_sigemax

percentage_dose_sigemax <- ED(fitSigEmax, p = 0.9, direction = 'decreasing')
percentage_dose_sigemax
```

Predict the effect of more doses, e.g. $20$ and $40$ (book p. 220)
```{r}
pred_emax <- predict(fitEmax, doseSeq = c(20, 40), predType = 'effect-curve', se.fit = T)
pred_emax

pred_sigemax <- predict(fitSigEmax, doseSeq = c(20, 40), predType = 'effect-curve', se.fit = T)
pred_sigemax 

# TODO: explain why setting effect-curve is needed!!
```
```

