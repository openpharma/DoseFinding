<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Longitudinal Data MCP-Mod • DoseFinding</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Longitudinal Data MCP-Mod">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DoseFinding</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3-1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analysis_normal.html">Continuous data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/binary_data.html">Binary Data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">MCP-Mod FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/longitudinal_data.html">Longitudinal Data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/mult_regimen.html">Multiple Regimen MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/overview.html">Overview DoseFinding package</a></li>
    <li><a class="dropdown-item" href="../articles/sample_size.html">Sample size calculations for MCP-Mod</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/DoseFinding/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Longitudinal Data MCP-Mod</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/DoseFinding/blob/master/vignettes/longitudinal_data.Rmd" class="external-link"><code>vignettes/longitudinal_data.Rmd</code></a></small>
      <div class="d-none name"><code>longitudinal_data.Rmd</code></div>
    </div>

    
    
<p>In this vignette we illustrate how to use the
<code>DoseFinding</code> package with longitudinal, continuous
observations by fitting a mixed model for repeated measures (MMRM) and
applying the generalized MCP-Mod methodology to the resulting estimates.
We also show how to apply futility analyses during the trial, following
<span class="citation">Bornkamp et al. (<a href="#ref-bornkamp2024">2024</a>)</span>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/openpharma/DoseFinding" class="external-link">DoseFinding</a></span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="data-simulation-code">Data Simulation Code<a class="anchor" aria-label="anchor" href="#data-simulation-code"></a>
</h2>
<p>In order to illustrate the methodology, we are going to consider data
as simulated in Section 4.1 of <span class="citation">Bornkamp et al.
(<a href="#ref-bornkamp2024">2024</a>)</span>. We include the
corresponding functions here for completeness. This can be helpful for
users who want to simulate their own data during trial design.</p>
<div class="section level3">
<h3 id="calculate-mean-response-from-emax-model">Calculate Mean Response from Emax Model<a class="anchor" aria-label="anchor" href="#calculate-mean-response-from-emax-model"></a>
</h3>
<p>The <code>calcMean</code> function calculates the mean response at
each dose and each time point under the Emax model with <span class="math inline">\(\text{E}_0 = 0\)</span> and <span class="math inline">\(\text{ED}_{50} = 1\)</span> with the <span class="math inline">\(\text{E}_{max}\)</span> parameter gradually
increasing so that a pre-specified maximum effect is achieved at the
last visit. The function takes three arguments: <code>dose</code> is a
vector of doses, <code>times</code> is a vector of time points, and
<code>maxEff</code> is the maximum effect at the final analysis (i.e.,
for the highest dose at the last visit). It returns a matrix of mean
responses, where the rows correspond to doses and the columns correspond
to time points.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">calcMean</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dose</span>, <span class="va">times</span>, <span class="va">maxEff</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">emaxLastVisit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fl">1</span>, doses <span class="op">=</span> <span class="va">dose</span>, maxEff <span class="op">=</span> <span class="va">maxEff</span><span class="op">)</span><span class="op">$</span><span class="va">emax</span><span class="op">[</span><span class="st">"eMax"</span><span class="op">]</span></span>
<span>  <span class="va">maxTime</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/outer.html" class="external-link">outer</a></span><span class="op">(</span><span class="va">dose</span>, <span class="va">times</span>, <span class="kw">function</span><span class="op">(</span><span class="va">doses</span>, <span class="va">times</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">Emax</span> <span class="op">&lt;-</span> <span class="va">emaxLastVisit</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">times</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="va">maxTime</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">Emax</span> <span class="op">*</span> <span class="va">doses</span> <span class="op">/</span> <span class="op">(</span><span class="va">doses</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="fu">calcMean</span><span class="op">(</span></span>
<span>  dose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  times <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>  maxEff <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<pre><code>     [,1]       [,2]       [,3]       [,4]       [,5]       [,6]       [,7]
[1,]    0 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000 0.00000000
[2,]    0 0.01650577 0.02651703 0.03258916 0.03627210 0.03850591 0.03986079
[3,]    0 0.02475866 0.03977554 0.04888374 0.05440814 0.05775886 0.05979118
[4,]    0 0.03301154 0.05303405 0.06517832 0.07254419 0.07701182 0.07972157
[5,]    0 0.03961385 0.06364086 0.07821399 0.08705303 0.09241418 0.09566588
           [,8]       [,9]      [,10]      [,11]
[1,] 0.00000000 0.00000000 0.00000000 0.00000000
[2,] 0.04068256 0.04118099 0.04148330 0.04166667
[3,] 0.06102384 0.06177149 0.06222496 0.06250000
[4,] 0.08136512 0.08236198 0.08296661 0.08333333
[5,] 0.09763814 0.09883438 0.09955993 0.10000000</code></pre>
</div>
<div class="section level3">
<h3 id="generate-normal-mean-vector-and-covariance-matrix">Generate Normal Mean Vector and Covariance Matrix<a class="anchor" aria-label="anchor" href="#generate-normal-mean-vector-and-covariance-matrix"></a>
</h3>
<p>The <code>parGen</code> function returns the mean and
(compound-symmetry) covariance matrix for the continuous outcomes, given
the same input as for <code>calcMean</code> above, plus the baseline
mean <code>bslMean</code>, and the standard deviation <code>errSD</code>
and constant correlation <code>rho</code> of the residuals:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">parGen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">times</span>, <span class="va">doses</span>, <span class="va">maxEff</span>, <span class="va">bslMean</span> <span class="op">=</span> <span class="fl">0</span>, <span class="va">errSD</span> <span class="op">=</span> <span class="fl">0.55</span>, <span class="va">rho</span> <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span>
<span>  <span class="va">ndim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## matrix of outcome means for each dose and visit</span></span>
<span>  <span class="va">MeanMat</span> <span class="op">&lt;-</span> <span class="fu">calcMean</span><span class="op">(</span><span class="va">doses</span>, <span class="va">times</span>, <span class="va">maxEff</span><span class="op">)</span> <span class="op">+</span> <span class="va">bslMean</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">MeanMat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Dose"</span>, <span class="va">doses</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">MeanMat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Week"</span>, <span class="va">times</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## cov mat. for err</span></span>
<span>  <span class="va">sdV</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">errSD</span><span class="op">)</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">errSD</span>, <span class="va">ndim</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">errSD</span><span class="op">)</span> <span class="op">==</span> <span class="va">ndim</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">errSD</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Length of err sd should either be 1 (homogeneous) or equal to the number of visits in times"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">## CS covariance structure</span></span>
<span>  <span class="va">R</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">ndim</span><span class="op">)</span></span>
<span>  <span class="va">R</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">lower.tri</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">R</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="va">R</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">rho</span></span>
<span>  <span class="va">Sigm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sdV</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">R</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">sdV</span><span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>visit <span class="op">=</span> <span class="va">times</span>, Sigm <span class="op">=</span> <span class="va">Sigm</span>, MeanMat <span class="op">=</span> <span class="va">MeanMat</span>, bslMean <span class="op">=</span> <span class="va">bslMean</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">parGen</span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="fl">10</span>,</span>
<span>  doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  maxEff <span class="op">=</span> <span class="fl">0.1</span>,</span>
<span>  bslMean <span class="op">=</span> <span class="fl">1.5</span></span>
<span><span class="op">)</span></span>
<span><span class="va">pars</span></span></code></pre></div>
<pre><code>$visit
 [1]  0  1  2  3  4  5  6  7  8  9 10

$Sigm
         [,1]    [,2]    [,3]    [,4]    [,5]    [,6]    [,7]    [,8]    [,9]
 [1,] 0.30250 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225
 [2,] 0.27225 0.30250 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225
 [3,] 0.27225 0.27225 0.30250 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225
 [4,] 0.27225 0.27225 0.27225 0.30250 0.27225 0.27225 0.27225 0.27225 0.27225
 [5,] 0.27225 0.27225 0.27225 0.27225 0.30250 0.27225 0.27225 0.27225 0.27225
 [6,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.30250 0.27225 0.27225 0.27225
 [7,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.30250 0.27225 0.27225
 [8,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.30250 0.27225
 [9,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.30250
[10,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225
[11,] 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225 0.27225
        [,10]   [,11]
 [1,] 0.27225 0.27225
 [2,] 0.27225 0.27225
 [3,] 0.27225 0.27225
 [4,] 0.27225 0.27225
 [5,] 0.27225 0.27225
 [6,] 0.27225 0.27225
 [7,] 0.27225 0.27225
 [8,] 0.27225 0.27225
 [9,] 0.27225 0.27225
[10,] 0.30250 0.27225
[11,] 0.27225 0.30250

$MeanMat
        Week0    Week1    Week2    Week3    Week4    Week5    Week6    Week7
Dose0     1.5 1.500000 1.500000 1.500000 1.500000 1.500000 1.500000 1.500000
Dose0.5   1.5 1.516506 1.526517 1.532589 1.536272 1.538506 1.539861 1.540683
Dose1     1.5 1.524759 1.539776 1.548884 1.554408 1.557759 1.559791 1.561024
Dose2     1.5 1.533012 1.553034 1.565178 1.572544 1.577012 1.579722 1.581365
Dose4     1.5 1.539614 1.563641 1.578214 1.587053 1.592414 1.595666 1.597638
           Week8    Week9   Week10
Dose0   1.500000 1.500000 1.500000
Dose0.5 1.541181 1.541483 1.541667
Dose1   1.561771 1.562225 1.562500
Dose2   1.582362 1.582967 1.583333
Dose4   1.598834 1.599560 1.600000

$bslMean
[1] 1.5</code></pre>
<p>Note that we assume here that the time is in weeks, but that could of
course easily be adapted as needed for your project.</p>
</div>
<div class="section level3">
<h3 id="simulate-longitudinal-outcomes">Simulate Longitudinal Outcomes<a class="anchor" aria-label="anchor" href="#simulate-longitudinal-outcomes"></a>
</h3>
<p>The <code>datGen</code> function simulates the longitudinal outcome
data, given a sample size of patients <code>N</code>, a list of
parameters <code>pars</code> (as generated by <code>parGen</code>), a
vector of <code>doses</code> and corresponding allocation ratios
<code>alRatio</code>, the enrollment time of the last patient
<code>LPFV.t</code>. The distribution of the recruitment time can be
specified by <code>RecrDist</code> and <code>RandRecr</code>, with the
following options:</p>
<ul>
<li>
<code>RecrDist = "Quad"</code>: quadratic, <span class="math inline">\(a t^2\)</span>, where <span class="math inline">\(a = N / LPFV.t^2\)</span>.
<ul>
<li>
<code>RandRecr = TRUE</code>: <span class="math inline">\(t \sim
\sqrt{N \cdot \text{Unif}(0,1) / a}\)</span>.</li>
<li>
<code>RandRecr = FALSE</code>: <span class="math inline">\(t =
\sqrt{i / a}\)</span>, where <span class="math inline">\(i = 1, \dotsc,
N\)</span>.</li>
</ul>
</li>
<li>
<code>Exp</code>: exponential, with rate <span class="math inline">\(\lambda = -\log(0.9 / N) / LPFV.t\)</span>.
<ul>
<li>
<code>RandRecr = TRUE</code>: <span class="math inline">\(t \sim
\text{Exp}(\lambda)\)</span>.</li>
<li>
<code>RandRecr = FALSE</code>: <span class="math inline">\(t =
F_{\text{Exp}(\lambda)}^{-1}(i/N)\)</span> for <span class="math inline">\(i = 1, \dotsc, N-1\)</span>; <span class="math inline">\(t = LPFV.t\)</span> for <span class="math inline">\(i = N\)</span>.</li>
</ul>
</li>
<li>
<code>Unif</code>: uniform, <span class="math inline">\(t \sim
\text{Unif}(0, LPFV.t)\)</span>.
<ul>
<li>
<code>RandRecr = TRUE</code>: <span class="math inline">\(t \sim
\text{Unif}(0, LPFV.t)\)</span>.</li>
<li>
<code>RandRecr = FALSE</code>: <span class="math inline">\(t = i
\cdot LPFV.t / N\)</span> for <span class="math inline">\(i = 1, \dotsc,
N\)</span>.</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">datGen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">N</span> <span class="op">=</span> <span class="fl">300</span>, <span class="va">pars</span>, <span class="va">doses</span>, <span class="va">alRatio</span>, <span class="va">LPFV.t</span>, <span class="va">RecrDist</span> <span class="op">=</span> <span class="st">"Quad"</span>, <span class="va">RandRecr</span> <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">K</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span></span>
<span>  <span class="va">nt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">visit</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## generate list of dose arms</span></span>
<span>  <span class="va">nblk</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">N</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">alRatio</span><span class="op">)</span><span class="op">)</span> <span class="co"># number of blocks</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">nblk</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">K</span>, <span class="va">alRatio</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">alRatio</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">d</span> <span class="op">&lt;-</span> <span class="va">d</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">]</span></span>
<span></span>
<span>  <span class="va">err</span> <span class="op">&lt;-</span> <span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="va">N</span>, mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">nt</span><span class="op">)</span>, sigma <span class="op">=</span> <span class="va">pars</span><span class="op">$</span><span class="va">Sigm</span><span class="op">)</span> <span class="co"># error term</span></span>
<span></span>
<span>  <span class="va">Y</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">MeanMat</span><span class="op">[</span><span class="va">d</span>, <span class="op">]</span> <span class="op">+</span> <span class="va">err</span> <span class="co"># complete outcomes</span></span>
<span></span>
<span>  <span class="co">## enrollment time (week)</span></span>
<span>  <span class="va">randT</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">RecrDist</span> <span class="op">==</span> <span class="st">"Quad"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">a</span> <span class="op">&lt;-</span> <span class="va">N</span> <span class="op">/</span> <span class="va">LPFV.t</span><span class="op">^</span><span class="fl">2</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">RandRecr</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">N</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span><span class="op">)</span> <span class="op">/</span> <span class="va">a</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">/</span> <span class="va">a</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">RecrDist</span> <span class="op">==</span> <span class="st">"Exp"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">lamb</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">0.9</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span> <span class="op">/</span> <span class="va">LPFV.t</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">RandRecr</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">rexp</a></span><span class="op">(</span><span class="va">N</span>, rate <span class="op">=</span> <span class="va">lamb</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Exponential.html" class="external-link">qexp</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">N</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span>, <span class="va">lamb</span><span class="op">)</span>, <span class="va">LPFV.t</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">RecrDist</span> <span class="op">==</span> <span class="st">"Unif"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">RandRecr</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="va">LPFV.t</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span><span class="op">)</span> <span class="op">*</span> <span class="va">LPFV.t</span> <span class="op">/</span> <span class="va">N</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">trdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">N</span>, <span class="va">doses</span><span class="op">[</span><span class="va">d</span><span class="op">]</span>, <span class="va">randT</span>, <span class="va">Y</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">trdat</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">3</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SUBJID"</span>, <span class="st">"Dose"</span>, <span class="st">"enroll.time"</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">trdat</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html" class="external-link">gather</a></span><span class="op">(</span><span class="st">"Visit"</span>, <span class="st">"response"</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SUBJID"</span>, <span class="st">"Dose"</span>, <span class="st">"enroll.time"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">SUBJID</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">week</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">pars</span><span class="op">$</span><span class="va">visit</span>, <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">cal.time</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">enroll.time</span> <span class="op">+</span> <span class="va">out</span><span class="op">$</span><span class="va">week</span></span>
<span></span>
<span>  <span class="va">bsl</span> <span class="op">&lt;-</span> <span class="va">out</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">&lt;=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="st">"SUBJID"</span>, <span class="st">"response"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>base <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="va">bsl</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html" class="external-link">left_join</a></span><span class="op">(</span><span class="va">out</span>, by <span class="op">=</span> <span class="st">"SUBJID"</span>, multiple <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>chg <span class="op">=</span> <span class="va">response</span> <span class="op">-</span> <span class="va">base</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="st">"response"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html" class="external-link">rename</a></span><span class="op">(</span>response <span class="op">=</span> <span class="st">"chg"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>USUBJID <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"PAT"</span>, <span class="va">SUBJID</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="st">"Visit"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"Week"</span>, <span class="va">pars</span><span class="op">$</span><span class="va">visit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html" class="external-link">mutate_at</a></span><span class="op">(</span><span class="st">"Dose"</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">x</span>, levels <span class="op">=</span> <span class="va">doses</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">SUBJID</span>, <span class="va">week</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu">datGen</span><span class="op">(</span></span>
<span>  N <span class="op">=</span> <span class="fl">300</span>,</span>
<span>  pars <span class="op">=</span> <span class="va">pars</span>,</span>
<span>  doses <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>  alRatio <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>  LPFV.t <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  RecrDist <span class="op">=</span> <span class="st">"Quad"</span>,</span>
<span>  RandRecr <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">15</span><span class="op">)</span></span></code></pre></div>
<pre><code> [38;5;246m# A tibble: 15 × 9 [39m
   SUBJID  base Dose  enroll.time Visit   week cal.time response USUBJID
     [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;fct&gt; [39m [23m        [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;fct&gt; [39m [23m   [3m [38;5;246m&lt;int&gt; [39m [23m     [3m [38;5;246m&lt;dbl&gt; [39m [23m     [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;chr&gt; [39m [23m  
 [38;5;250m 1 [39m      1 1.83  4            9.75 Week0      0     9.75   0      PAT1   
 [38;5;250m 2 [39m      1 1.83  4            9.75 Week1      1    10.8    0.198  PAT1   
 [38;5;250m 3 [39m      1 1.83  4            9.75 Week2      2    11.8   - [31m0 [39m [31m. [39m [31m103 [39m  PAT1   
 [38;5;250m 4 [39m      1 1.83  4            9.75 Week3      3    12.8    0.270  PAT1   
 [38;5;250m 5 [39m      1 1.83  4            9.75 Week4      4    13.8   - [31m0 [39m [31m. [39m [31m150 [39m  PAT1   
 [38;5;250m 6 [39m      1 1.83  4            9.75 Week5      5    14.8    0.183  PAT1   
 [38;5;250m 7 [39m      1 1.83  4            9.75 Week6      6    15.8    0.158  PAT1   
 [38;5;250m 8 [39m      1 1.83  4            9.75 Week7      7    16.8    0.454  PAT1   
 [38;5;250m 9 [39m      1 1.83  4            9.75 Week8      8    17.8   - [31m0 [39m [31m. [39m [31m0 [39m [31m28 [4m1 [24m [39m PAT1   
 [38;5;250m10 [39m      1 1.83  4            9.75 Week9      9    18.8    0.474  PAT1   
 [38;5;250m11 [39m      1 1.83  4            9.75 Week10    10    19.8    0.354  PAT1   
 [38;5;250m12 [39m      2 0.462 1            1.52 Week0      0     1.52   0      PAT2   
 [38;5;250m13 [39m      2 0.462 1            1.52 Week1      1     2.52   0.405  PAT2   
 [38;5;250m14 [39m      2 0.462 1            1.52 Week2      2     3.52   0.271  PAT2   
 [38;5;250m15 [39m      2 0.462 1            1.52 Week3      3     4.52   0.382  PAT2   </code></pre>
<p>So we see that the function generates a <code>data.frame</code> with
the subject ID, baseline value, dose, enrollment time, visit and week
plus calendar time for each longitudinal observation.</p>
</div>
<div class="section level3">
<h3 id="cut-interim-data">Cut Interim Data<a class="anchor" aria-label="anchor" href="#cut-interim-data"></a>
</h3>
<p>The <code>intDat</code> function cuts the interim data when a certain
proportion <code>pct</code> of patients have their final outcome. It
returns a list with the interim analysis time <code>int.time</code>, the
cut data <code>dat</code> and the distribution of the last visit
<code>dist</code> (i.e., the number of patients with their last visit at
each time point).</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">intDat</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">data</span>, <span class="va">pct</span> <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">SUBJID</span><span class="op">)</span></span>
<span>  <span class="va">tmax</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">data</span><span class="op">$</span><span class="va">week</span><span class="op">)</span></span>
<span>  <span class="va">sorted_final_cal_time</span> <span class="op">&lt;-</span> <span class="va">data</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">==</span> <span class="va">tmax</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html" class="external-link">pull</a></span><span class="op">(</span><span class="va">cal.time</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">N_required</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="va">pct</span> <span class="op">*</span> <span class="va">N</span><span class="op">)</span></span>
<span>  <span class="va">t.cut</span> <span class="op">&lt;-</span> <span class="va">sorted_final_cal_time</span><span class="op">[</span><span class="va">N_required</span><span class="op">]</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>int.time <span class="op">=</span> <span class="va">t.cut</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">data</span>, <span class="va">cal.time</span> <span class="op">&lt;=</span> <span class="va">t.cut</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">dist</span> <span class="op">&lt;-</span> <span class="va">out</span><span class="op">$</span><span class="va">dat</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">SUBJID</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>lastvis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">week</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">lastvis</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>        n <span class="op">=</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span>, </span>
<span>        pct <span class="op">=</span> <span class="op">(</span><span class="fl">100</span> <span class="op">*</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html" class="external-link">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">/</span> <span class="va">N</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="va">int_dat</span> <span class="op">&lt;-</span> <span class="fu">intDat</span><span class="op">(</span><span class="va">dat</span>, pct <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">int_dat</span></span></code></pre></div>
<pre><code>$int.time
[1] 17.06187

$dat
 [38;5;246m# A tibble: 2,998 × 9 [39m
   SUBJID  base Dose  enroll.time Visit  week cal.time response USUBJID
     [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;fct&gt; [39m [23m        [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;fct&gt; [39m [23m  [3m [38;5;246m&lt;int&gt; [39m [23m     [3m [38;5;246m&lt;dbl&gt; [39m [23m     [3m [38;5;246m&lt;dbl&gt; [39m [23m  [3m [38;5;246m&lt;chr&gt; [39m [23m  
 [38;5;250m 1 [39m      1 1.83  4            9.75 Week0     0     9.75    0     PAT1   
 [38;5;250m 2 [39m      1 1.83  4            9.75 Week1     1    10.8     0.198 PAT1   
 [38;5;250m 3 [39m      1 1.83  4            9.75 Week2     2    11.8    - [31m0 [39m [31m. [39m [31m103 [39m PAT1   
 [38;5;250m 4 [39m      1 1.83  4            9.75 Week3     3    12.8     0.270 PAT1   
 [38;5;250m 5 [39m      1 1.83  4            9.75 Week4     4    13.8    - [31m0 [39m [31m. [39m [31m150 [39m PAT1   
 [38;5;250m 6 [39m      1 1.83  4            9.75 Week5     5    14.8     0.183 PAT1   
 [38;5;250m 7 [39m      1 1.83  4            9.75 Week6     6    15.8     0.158 PAT1   
 [38;5;250m 8 [39m      1 1.83  4            9.75 Week7     7    16.8     0.454 PAT1   
 [38;5;250m 9 [39m      2 0.462 1            1.52 Week0     0     1.52    0     PAT2   
 [38;5;250m10 [39m      2 0.462 1            1.52 Week1     1     2.52    0.405 PAT2   
 [38;5;246m# ℹ 2,988 more rows [39m

$dist
 [38;5;246m# A tibble: 4 × 3 [39m
  lastvis     n   pct
     [3m [38;5;246m&lt;int&gt; [39m [23m  [3m [38;5;246m&lt;int&gt; [39m [23m  [3m [38;5;246m&lt;dbl&gt; [39m [23m
 [38;5;250m1 [39m       7    48  16  
 [38;5;250m2 [39m       8    56  18.7
 [38;5;250m3 [39m       9    46  15.3
 [38;5;250m4 [39m      10   150  50  </code></pre>
</div>
</div>
<div class="section level2">
<h2 id="longitudinal-data-analysis">Longitudinal Data Analysis<a class="anchor" aria-label="anchor" href="#longitudinal-data-analysis"></a>
</h2>
<p>Given a longitudinal dataset (at an interim analysis), we can perform
two analyses:</p>
<ol style="list-style-type: decimal">
<li>Completers analysis: Subset the data to patients who have reached
the last visit, and then apply a simple linear model.</li>
<li>Repeated measures analysis: Fit a mixed model for repeated measures
(MMRM) to the data.</li>
</ol>
<p>In both cases, we then calculate the least square means <span class="math inline">\(\widehat{\mu}_{0t}\)</span> and the covariance
matrix <span class="math inline">\(S_{0t}\)</span> of the least square
means, as well as the residual standard deviation <span class="math inline">\(\sigma\)</span> of the model.</p>
<p>Let’s code these in two corresponding functions:</p>
<div class="section level3">
<h3 id="completers-analysis">Completers Analysis<a class="anchor" aria-label="anchor" href="#completers-analysis"></a>
</h3>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analyzeCompleters</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">eval.time</span> <span class="op">=</span> <span class="st">"Week12"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">complDat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Visit</span> <span class="op">==</span> <span class="va">eval.time</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">response</span> <span class="op">~</span> <span class="va">Dose</span> <span class="op">+</span> <span class="va">base</span>, data <span class="op">=</span> <span class="va">complDat</span><span class="op">)</span></span>
<span>  <span class="va">lsm</span> <span class="op">&lt;-</span> <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="https://rvlenth.github.io/emmeans/reference/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">fit</span>, <span class="op">~</span> <span class="va">Dose</span><span class="op">)</span></span>
<span>  <span class="va">summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lsm</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">rowIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">summ</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mu0t <span class="op">=</span> <span class="va">summ</span><span class="op">$</span><span class="va">emmean</span>,</span>
<span>    sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sigma.html" class="external-link">sigma</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span>,</span>
<span>    S0t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">lsm</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="va">resultCompleters</span> <span class="op">&lt;-</span> <span class="fu">analyzeCompleters</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">int_dat</span><span class="op">$</span><span class="va">dat</span>,</span>
<span>  eval.time <span class="op">=</span> <span class="st">"Week10"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">resultCompleters</span></span></code></pre></div>
<pre><code>$mu0t
[1] -0.06011853  0.04853842  0.06463132  0.11936622  0.14242645

$sigma
[1] 0.2499916

$S0t
                0           0.5             1             2             4
0    1.838760e-03  3.272396e-06 -4.632441e-06  4.028387e-07  6.215931e-07
0.5  3.272396e-06  2.248530e-03 -2.341013e-05  2.035753e-06  3.141233e-06
1   -4.632441e-06 -2.341013e-05  2.049133e-03 -2.881835e-06 -4.446765e-06
2    4.028387e-07  2.035753e-06 -2.881835e-06  2.500083e-03  3.866923e-07
4    6.215931e-07  3.141233e-06 -4.446765e-06  3.866923e-07  1.953591e-03</code></pre>
</div>
<div class="section level3">
<h3 id="repeated-measures-analysis">Repeated Measures Analysis<a class="anchor" aria-label="anchor" href="#repeated-measures-analysis"></a>
</h3>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">analyzeRepeated</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">dat</span>, <span class="va">eval.time</span> <span class="op">=</span> <span class="st">"Week12"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">form</span> <span class="op">&lt;-</span> <span class="st">"response ~  Visit + Dose + base + Dose*Visit + base*Visit"</span></span>
<span>  <span class="va">postBaselineDat</span> <span class="op">&lt;-</span> <span class="va">dat</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">week</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu">mmrm</span><span class="fu">::</span><span class="fu"><a href="https://openpharma.github.io/mmrm/latest-tag/reference/mmrm.html" class="external-link">mmrm</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">form</span>, <span class="st">" + us(Visit | USUBJID)"</span><span class="op">)</span><span class="op">)</span>, data <span class="op">=</span> <span class="va">postBaselineDat</span><span class="op">)</span></span>
<span>  <span class="va">lsm</span> <span class="op">&lt;-</span> <span class="fu">emmeans</span><span class="fu">::</span><span class="fu"><a href="https://rvlenth.github.io/emmeans/reference/emmeans.html" class="external-link">emmeans</a></span><span class="op">(</span><span class="va">fit</span>, <span class="op">~</span> <span class="va">Dose</span> <span class="op">+</span> <span class="va">Visit</span><span class="op">)</span></span>
<span>  <span class="va">summ</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">lsm</span><span class="op">)</span>, <span class="va">Visit</span> <span class="op">==</span> <span class="va">eval.time</span><span class="op">)</span></span>
<span>  <span class="va">rowIDs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">summ</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    mu0t <span class="op">=</span> <span class="va">summ</span><span class="op">$</span><span class="va">emmean</span>,</span>
<span>    sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu">mmrm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/nlme/man/VarCorr.html" class="external-link">VarCorr</a></span><span class="op">(</span><span class="va">fit</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">eval.time</span><span class="op">]</span>,</span>
<span>    S0t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">lsm</span><span class="op">)</span><span class="op">[</span><span class="va">rowIDs</span>, <span class="va">rowIDs</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Let's try it out:</span></span>
<span><span class="va">resultRepeated</span> <span class="op">&lt;-</span> <span class="fu">analyzeRepeated</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">int_dat</span><span class="op">$</span><span class="va">dat</span>,</span>
<span>  eval.time <span class="op">=</span> <span class="st">"Week10"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">resultRepeated</span></span></code></pre></div>
<pre><code>$mu0t
[1] -0.02818037  0.05291721  0.09861362  0.13468919  0.14456095

$sigma
   Week10 
0.2513171 

$S0t
                0 Week10    0.5 Week10      1 Week10      2 Week10
0 Week10    1.430501e-03 -1.818752e-06  1.529028e-06 -5.639547e-07
0.5 Week10 -1.818752e-06  1.626728e-03 -1.358336e-05  1.101611e-06
1 Week10    1.529028e-06 -1.358336e-05  1.539021e-03 -8.100511e-08
2 Week10   -5.639547e-07  1.101611e-06 -8.100511e-08  1.743068e-03
4 Week10    1.596990e-07 -6.294172e-07  7.022021e-07 -1.325705e-07
                4 Week10
0 Week10    1.596990e-07
0.5 Week10 -6.294172e-07
1 Week10    7.022021e-07
2 Week10   -1.325705e-07
4 Week10    1.484844e-03</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="generalized-mcp-mod">Generalized MCP-Mod<a class="anchor" aria-label="anchor" href="#generalized-mcp-mod"></a>
</h2>
<div class="section level3">
<h3 id="final-analysis">Final Analysis<a class="anchor" aria-label="anchor" href="#final-analysis"></a>
</h3>
<p>At the final analysis, we would like to use the generalized MCP-Mod
methodology to test the hypothesis of a dose-response relationship. This
is easily done by providing the least square means via <code>resp</code>
and their covariance matrix via <code>S</code> to the
<code>MCTtest</code> function, which will then perform the MCP-Mod
analysis. We just need to also specify the dose levels and the models we
want to test: Here we just use three models, it could be more in
practice.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span></span>
<span>  emax <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>  quadratic <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span>,</span>
<span>  doses <span class="op">=</span> <span class="va">doses</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">resultFinal</span> <span class="op">&lt;-</span> <span class="fu">analyzeRepeated</span><span class="op">(</span></span>
<span>  dat <span class="op">=</span> <span class="va">dat</span>,</span>
<span>  eval.time <span class="op">=</span> <span class="st">"Week10"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">testFinal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MCTtest.html">MCTtest</a></span><span class="op">(</span></span>
<span>  dose <span class="op">=</span> <span class="va">doses</span>,</span>
<span>  resp <span class="op">=</span> <span class="va">resultFinal</span><span class="op">$</span><span class="va">mu0t</span>,</span>
<span>  S <span class="op">=</span> <span class="va">resultFinal</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>  models <span class="op">=</span> <span class="va">models</span>,</span>
<span>  alternative <span class="op">=</span> <span class="st">"one.sided"</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"general"</span>,</span>
<span>  critV <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pVal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.025</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">testFinal</span></span></code></pre></div>
<pre><code>Multiple Contrast Test

Contrasts:
      emax sigEmax quadratic
0   -0.657  -0.788    -0.722
0.5 -0.271  -0.203    -0.223
1   -0.013   0.251     0.167
2    0.309   0.363     0.611
4    0.632   0.378     0.167

Contrast Correlation:
           emax sigEmax quadratic
emax      1.000   0.921     0.827
sigEmax   0.921   1.000     0.941
quadratic 0.827   0.941     1.000

Multiple Contrast Test:
          t-Stat  adj-p
emax       3.987 &lt;0.001
sigEmax    3.588 &lt;0.001
quadratic  3.574 &lt;0.001

Critical value: 2.18 (alpha = 0.025, one-sided)</code></pre>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testFinal</span><span class="op">$</span><span class="va">critV</span></span></code></pre></div>
<pre><code>[1] 2.180088
attr(,"Calc")
[1] TRUE</code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">testFinal</span><span class="op">$</span><span class="va">tStat</span></span></code></pre></div>
<pre><code>     emax   sigEmax quadratic 
 3.986915  3.588199  3.574414 
attr(,"pVal")
[1] 3.940677e-05 2.383234e-04 2.215375e-04</code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">testFinal</span><span class="op">$</span><span class="va">tStat</span>, <span class="st">"pVal"</span><span class="op">)</span></span></code></pre></div>
<pre><code>[1] 3.940677e-05 2.383234e-04 2.215375e-04</code></pre>
</div>
<div class="section level3">
<h3 id="futility-interim-analysis">Futility Interim Analysis<a class="anchor" aria-label="anchor" href="#futility-interim-analysis"></a>
</h3>
<p>Here we show how to apply the futility analysis during the trial, as
described in <span class="citation">Bornkamp et al. (<a href="#ref-bornkamp2024">2024</a>)</span>. The idea is that based on the
available interim data, we calculate the predictive or conditional power
to detect a significant dose-response relationship at the final
analysis. If this value is below a certain threshold, we may want to
stop the trial for futility. We can use the <code>powMCTInterim</code>
function to calculate these values. To do so, we need two additional
ingredients:</p>
<ol style="list-style-type: decimal">
<li>The contrast matrix for the models we want to test, which is
provided via the argument <code>contMat</code>.</li>
<li>The covariance matrix at the final analysis, denoted by <span class="math inline">\(S_{[0,1]}\)</span> in <span class="citation">Bornkamp et al. (<a href="#ref-bornkamp2024">2024</a>)</span> and provided via the argument
<code>S_01</code> here. Here we assume that this matrix is diagonal,
with constant entries <span class="math inline">\(\sigma^2 / n\)</span>,
where <span class="math inline">\(\sigma\)</span> is the residual
standard deviation of the model and <span class="math inline">\(n\)</span> is the number of patients in the final
analysis.</li>
<li>For the conditional power, we also need to specify the assumed dose
group means at the primary analysis time-point. This is provided via the
argument <code>mu_assumed</code>. Typically, this is based on adding the
observed placebo response rate to the originally planned treatment
effect (before study start).</li>
</ol>
<p>Let’s calculate these now for the example interim data from
above:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">w</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">contMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, w <span class="op">=</span> <span class="va">w</span><span class="op">)</span><span class="op">$</span><span class="va">contMat</span></span>
<span></span>
<span><span class="va">n_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">S01</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">resultRepeated</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">n_final</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Predictive power:</span></span>
<span><span class="va">predPower</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>  contMat <span class="op">=</span> <span class="va">contMat</span>,,</span>
<span>  mu_0t <span class="op">=</span> <span class="va">resultRepeated</span><span class="op">$</span><span class="va">mu0t</span>,</span>
<span>  S_0t <span class="op">=</span> <span class="va">resultRepeated</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>  S_01 <span class="op">=</span> <span class="va">S01</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.025</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"predictive"</span>,</span>
<span>  alternative <span class="op">=</span> <span class="st">"one.sided"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">predPower</span></span></code></pre></div>
<pre><code>[1] 0.9996943
attr(,"error")
[1] 1.504715e-07
attr(,"msg")
[1] "Normal Completion"</code></pre>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Conditional power:</span></span>
<span><span class="va">deltaAssumed</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">$</span><span class="va">MeanMat</span><span class="op">[</span>, <span class="st">"Week10"</span><span class="op">]</span> <span class="op">-</span> <span class="va">pars</span><span class="op">$</span><span class="va">bslMean</span> </span>
<span><span class="va">deltaAssumed</span> <span class="op">&lt;-</span> <span class="va">deltaAssumed</span> <span class="op">-</span> <span class="va">deltaAssumed</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>  <span class="co"># assumed treatment difference vs placebo</span></span>
<span><span class="va">mu_assumed</span> <span class="op">&lt;-</span> <span class="va">resultRepeated</span><span class="op">$</span><span class="va">mu0t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">deltaAssumed</span> <span class="co"># to obtain group means add observed placebo response</span></span>
<span></span>
<span><span class="va">condPower</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>  contMat <span class="op">=</span> <span class="va">contMat</span>,</span>
<span>  mu_0t <span class="op">=</span> <span class="va">resultRepeated</span><span class="op">$</span><span class="va">mu0t</span>,</span>
<span>  S_0t <span class="op">=</span> <span class="va">resultRepeated</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>  S_01 <span class="op">=</span> <span class="va">S01</span>,</span>
<span>  mu_assumed <span class="op">=</span> <span class="va">mu_assumed</span>,</span>
<span>  alpha <span class="op">=</span> <span class="fl">0.025</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"conditional"</span>,</span>
<span>  alternative <span class="op">=</span> <span class="st">"one.sided"</span></span>
<span><span class="op">)</span></span>
<span><span class="va">condPower</span></span></code></pre></div>
<pre><code>[1] 0.9978589
attr(,"error")
[1] 6.728031e-07
attr(,"msg")
[1] "Normal Completion"</code></pre>
</div>
</div>
<div class="section level2">
<h2 id="simulation-study">Simulation study<a class="anchor" aria-label="anchor" href="#simulation-study"></a>
</h2>
<p>In practice, it will in most cases be important to run a simulation
study to evaluate the performance of the proposed combination of
generalized MCP-Mod with MMRM. In particular, in order to calibrate the
futility threshold for the interim analysis, it is important to
understand the power loss at the final analysis in relation to the
futility threshold. The following code may serve as the starting point
for such a simulation study, and can be adapted as needed. We include
here the argument documentation in <code>roxygen2</code> format for
simplicity. The code can also be used to reproduce the simulation study
in Section 4.1 of <span class="citation">Bornkamp et al. (<a href="#ref-bornkamp2024">2024</a>)</span>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">##' @param times Vector assessment times</span></span>
<span><span class="co">##' @param bslMean Mean at baseline</span></span>
<span><span class="co">##' @param errSD Residual standard deviation (on absolute scale)</span></span>
<span><span class="co">##' @param rho Correlation of measurements over time (within patient)</span></span>
<span><span class="co">##' @param maxEff Maximum effect achieved at last time-point for the highest dose</span></span>
<span><span class="co">##' @param RecrDist Recruitment distribution (see function datGen)</span></span>
<span><span class="co">##' @param LPFV.t Time for the last patient first visit</span></span>
<span><span class="co">##' @param models DoseFinding::Mods object</span></span>
<span><span class="co">##' @param ia_timing Information time when IAs are performed (% of patients having last visit)</span></span>
<span><span class="co">##' @param N Overall sample size</span></span>
<span><span class="co">##' @param doses doses to use</span></span>
<span><span class="co">##' @param alRatio allocation ratios to the different doses</span></span>
<span><span class="co">##' @param eval.time Name of final</span></span>
<span><span class="co">##' @param alpha Type 1 error for test</span></span>
<span><span class="co">##' @param nSim Number of simulations</span></span>
<span><span class="co">##' @param delta_assumed Vector of treatment effects assumed at the different doses</span></span>
<span><span class="co">##' @return Data frame with all results</span></span>
<span><span class="va">sim_one_trial</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">times</span>, <span class="va">bslMean</span>, <span class="va">errSD</span>, <span class="va">rho</span>, <span class="va">maxEff</span>,</span>
<span>                          <span class="va">RecrDist</span>, <span class="va">LPFV.t</span>, <span class="va">models</span>, <span class="va">ia_timing</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.05</span><span class="op">)</span>, <span class="va">N</span> <span class="op">=</span> <span class="fl">531</span>,</span>
<span>                          <span class="va">doses</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span>, <span class="va">alRatio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span>,</span>
<span>                          <span class="va">eval.time</span> <span class="op">=</span> <span class="st">"Week12"</span>, <span class="va">alpha</span> <span class="op">=</span> <span class="fl">0.025</span>, <span class="va">nSim</span> <span class="op">=</span> <span class="fl">1000</span>, <span class="va">delta_assumed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">contMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span>models <span class="op">=</span> <span class="va">models</span>, w <span class="op">=</span> <span class="va">alRatio</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">alRatio</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">contMat</span></span>
<span>  <span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu">parGen</span><span class="op">(</span><span class="va">times</span>, <span class="va">doses</span>,</span>
<span>    maxEff <span class="op">=</span> <span class="va">maxEff</span>, bslMean <span class="op">=</span> <span class="va">bslMean</span>, errSD <span class="op">=</span> <span class="va">errSD</span>,</span>
<span>    rho <span class="op">=</span> <span class="va">rho</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">mydat</span> <span class="op">&lt;-</span> <span class="fu">datGen</span><span class="op">(</span><span class="va">N</span>, <span class="va">pars</span>, <span class="va">doses</span>, <span class="va">alRatio</span>, LPFV.t <span class="op">=</span> <span class="va">LPFV.t</span>, RecrDist <span class="op">=</span> <span class="va">RecrDist</span>, RandRecr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## fit final data</span></span>
<span>  <span class="va">fit.final</span> <span class="op">&lt;-</span> <span class="fu">analyzeCompleters</span><span class="op">(</span><span class="va">mydat</span><span class="op">)</span></span>
<span>  <span class="va">test</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/MCTtest.html">MCTtest</a></span><span class="op">(</span></span>
<span>    dose <span class="op">=</span> <span class="va">doses</span>, resp <span class="op">=</span> <span class="va">fit.final</span><span class="op">$</span><span class="va">mu0t</span>, S <span class="op">=</span> <span class="va">fit.final</span><span class="op">$</span><span class="va">S0t</span>, models <span class="op">=</span> <span class="va">models</span>,</span>
<span>    alternative <span class="op">=</span> <span class="st">"one.sided"</span>, type <span class="op">=</span> <span class="st">"general"</span>, critV <span class="op">=</span> <span class="cn">TRUE</span>, pVal <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    alpha <span class="op">=</span> <span class="va">alpha</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">maxT</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">test</span><span class="op">$</span><span class="va">tStat</span><span class="op">)</span></span>
<span>  <span class="va">cVal</span> <span class="op">&lt;-</span> <span class="va">test</span><span class="op">$</span><span class="va">critVal</span></span>
<span></span>
<span>  <span class="va">n_final</span> <span class="op">&lt;-</span> <span class="va">mydat</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">Visit</span> <span class="op">==</span> <span class="va">eval.time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">Dose</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/count.html" class="external-link">count</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">IAtm</span> <span class="op">&lt;-</span> <span class="va">pp_long</span> <span class="op">&lt;-</span> <span class="va">cp_long</span> <span class="op">&lt;-</span> <span class="va">cp_long2</span> <span class="op">&lt;-</span> <span class="va">pp_compl</span> <span class="op">&lt;-</span> <span class="va">cp_compl</span> <span class="op">&lt;-</span> <span class="va">cp_compl2</span> <span class="op">&lt;-</span> <span class="va">inf_long</span> <span class="op">&lt;-</span> <span class="va">inf_compl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">IAdist</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span>nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">ia_timing</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## fit interim data</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">ia</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">ia_timing</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tp</span> <span class="op">&lt;-</span> <span class="va">ia_timing</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="co"># prop pts completes visit of eval.time</span></span>
<span>    <span class="va">cutDat</span> <span class="op">&lt;-</span> <span class="fu">intDat</span><span class="op">(</span><span class="va">mydat</span>, <span class="va">tp</span><span class="op">)</span></span>
<span>    <span class="va">middat</span> <span class="op">&lt;-</span> <span class="va">cutDat</span><span class="op">$</span><span class="va">dat</span></span>
<span>    <span class="va">IAtm</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cutDat</span><span class="op">$</span><span class="va">int.time</span></span>
<span>    <span class="va">IAdist</span><span class="op">[</span><span class="va">times</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cutDat</span><span class="op">$</span><span class="va">dist</span><span class="op">$</span><span class="va">lastvis</span>, <span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">cutDat</span><span class="op">$</span><span class="va">dist</span><span class="op">$</span><span class="va">pct</span></span>
<span></span>
<span>    <span class="co">## using all data from every patient (longitudinal MMRM)</span></span>
<span>    <span class="va">fit_int_long</span> <span class="op">&lt;-</span> <span class="fu">analyzeRepeated</span><span class="op">(</span><span class="va">middat</span>, eval.time <span class="op">=</span> <span class="va">eval.time</span><span class="op">)</span></span>
<span>    <span class="co">## only using the completers by visit eval time (cross-sectional linear model)</span></span>
<span>    <span class="va">fit_int_compl</span> <span class="op">&lt;-</span> <span class="fu">analyzeCompleters</span><span class="op">(</span><span class="va">middat</span>, eval.time <span class="op">=</span> <span class="va">eval.time</span><span class="op">)</span></span>
<span>    <span class="co">## The covariance matrix anticipated for the estimates at EoS</span></span>
<span>    <span class="va">S_end</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit_int_long</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">n_final</span><span class="op">$</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># information fraction</span></span>
<span>    <span class="va">inf_long</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit_int_long</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">n_final</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">fit_int_long</span><span class="op">$</span><span class="va">S0t</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">inf_compl</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">fit_int_compl</span><span class="op">$</span><span class="va">sigma</span><span class="op">^</span><span class="fl">2</span> <span class="op">/</span> <span class="va">n_final</span><span class="op">$</span><span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span> <span class="op">/</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/det.html" class="external-link">det</a></span><span class="op">(</span><span class="va">fit_int_compl</span><span class="op">$</span><span class="va">S0t</span><span class="op">)</span><span class="op">^</span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">mu_assumed</span> <span class="op">&lt;-</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">mu0t</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="va">delta_assumed</span> <span class="co"># for conditional power use planned treatment effect</span></span>
<span>    <span class="va">pp_long</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"predictive"</span>, alpha <span class="op">=</span> <span class="va">alpha</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">cp_long</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"conditional"</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,</span>
<span>      mu_assumed <span class="op">=</span> <span class="va">mu_assumed</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">cp_long2</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"conditional"</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,</span>
<span>      mu_assumed <span class="op">=</span> <span class="va">fit_int_long</span><span class="op">$</span><span class="va">mu0t</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">pp_compl</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"predictive"</span>, alpha <span class="op">=</span> <span class="va">alpha</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">cp_compl</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"conditional"</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,</span>
<span>      mu_assumed <span class="op">=</span> <span class="va">mu_assumed</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">cp_compl2</span><span class="op">[</span><span class="va">ia</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/powMCTInterim.html">powMCTInterim</a></span><span class="op">(</span></span>
<span>      contMat <span class="op">=</span> <span class="va">contMat</span>, S_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">S0t</span>,</span>
<span>      S_01 <span class="op">=</span> <span class="va">S_end</span>, mu_0t <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">mu0t</span>, type <span class="op">=</span> <span class="st">"conditional"</span>, alpha <span class="op">=</span> <span class="va">alpha</span>,</span>
<span>      mu_assumed <span class="op">=</span> <span class="va">fit_int_compl</span><span class="op">$</span><span class="va">mu0t</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    final_maxT <span class="op">=</span> <span class="va">maxT</span>, final_cVal <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">cVal</span><span class="op">)</span>,</span>
<span>    <span class="va">ia_timing</span>, <span class="va">pp_long</span>, <span class="va">cp_long</span>, <span class="va">cp_long2</span>, <span class="va">pp_compl</span>, <span class="va">cp_compl</span>, <span class="va">cp_compl2</span>, <span class="va">inf_long</span>, <span class="va">inf_compl</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## Function to run one scenario (arguments described in previous function)</span></span>
<span><span class="va">run_scen</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n_sim</span>, <span class="va">rho</span>, <span class="va">maxEff</span>,</span>
<span>                     <span class="va">LPFV.t</span>, <span class="va">ia_timing</span>, <span class="va">delta_assumed</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## fixed parameters</span></span>
<span>  <span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span> <span class="co"># doses</span></span>
<span>  <span class="va">alRatio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># allocation ratio for doses</span></span>
<span>  <span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.025</span></span>
<span>  <span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span></span>
<span>  <span class="va">bslMean</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>  <span class="va">errSD</span> <span class="op">&lt;-</span> <span class="fl">0.56</span></span>
<span>  <span class="va">RecrDist</span> <span class="op">&lt;-</span> <span class="st">"Quad"</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0.6</span> <span class="op">&amp;</span> <span class="va">LPFV.t</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span> <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">820</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0.6</span> <span class="op">&amp;</span> <span class="va">LPFV.t</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span> <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">825</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0.9</span> <span class="op">&amp;</span> <span class="va">LPFV.t</span> <span class="op">==</span> <span class="fl">50</span><span class="op">)</span> <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">248</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">rho</span> <span class="op">==</span> <span class="fl">0.9</span> <span class="op">&amp;</span> <span class="va">LPFV.t</span> <span class="op">==</span> <span class="fl">100</span><span class="op">)</span> <span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">236</span></span>
<span></span>
<span>  <span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span></span>
<span>    emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    quadratic <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, doses <span class="op">=</span> <span class="va">doses</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="va">lst</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="va">n_sim</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">n_sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">res</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu">sim_one_trial</span><span class="op">(</span></span>
<span>      times <span class="op">=</span> <span class="va">times</span>, bslMean <span class="op">=</span> <span class="va">bslMean</span>,</span>
<span>      errSD <span class="op">=</span> <span class="va">errSD</span>, rho <span class="op">=</span> <span class="va">rho</span>, maxEff <span class="op">=</span> <span class="va">maxEff</span>, RecrDist <span class="op">=</span> <span class="va">RecrDist</span>,</span>
<span>      LPFV.t <span class="op">=</span> <span class="va">LPFV.t</span>, models <span class="op">=</span> <span class="va">models</span>, ia_timing <span class="op">=</span> <span class="va">ia_timing</span>, N <span class="op">=</span> <span class="va">N</span>,</span>
<span>      doses <span class="op">=</span> <span class="va">doses</span>, alRatio <span class="op">=</span> <span class="va">alRatio</span>, delta_assumed <span class="op">=</span> <span class="va">delta_assumed</span>,</span>
<span>      alpha <span class="op">=</span> <span class="va">alpha</span></span>
<span>    <span class="op">)</span>, silent <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">res</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">lst</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>sim <span class="op">=</span> <span class="va">i</span>, <span class="va">res</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="st">"rbind"</span>, <span class="va">lst</span><span class="op">)</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="va">rho</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">maxEff</span> <span class="op">&lt;-</span> <span class="va">maxEff</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">RecrDist</span> <span class="op">&lt;-</span> <span class="va">RecrDist</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">N</span> <span class="op">&lt;-</span> <span class="va">N</span></span>
<span>  <span class="va">out</span><span class="op">$</span><span class="va">LPFV.t</span> <span class="op">&lt;-</span> <span class="va">LPFV.t</span></span>
<span>  <span class="va">out</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>These functions can be used as follows:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span><span class="op">)</span> <span class="co"># doses</span></span>
<span><span class="va">alRatio</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">2</span><span class="op">)</span> <span class="co"># allocation ratio for doses</span></span>
<span><span class="va">alpha</span> <span class="op">&lt;-</span> <span class="fl">0.025</span> <span class="co"># for MCTtest</span></span>
<span><span class="va">times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span>, <span class="fl">4</span>, <span class="fl">8</span>, <span class="fl">12</span><span class="op">)</span> <span class="co"># observation times (weeks)</span></span>
<span><span class="va">bslMean</span> <span class="op">&lt;-</span> <span class="fl">0</span> <span class="co"># mean at baseline</span></span>
<span><span class="va">errSD</span> <span class="op">&lt;-</span> <span class="fl">0.56</span> <span class="co"># SD for outcome on absolute scale</span></span>
<span><span class="va">RecrDist</span> <span class="op">&lt;-</span> <span class="st">"Quad"</span> <span class="co"># recruitment distribution</span></span>
<span></span>
<span><span class="va">rho</span> <span class="op">&lt;-</span> <span class="fl">0.9</span> <span class="co"># correlation across time for outcome on absolute scale</span></span>
<span><span class="va">LPFV.t</span> <span class="op">&lt;-</span> <span class="fl">100</span> <span class="co"># time of last patient first visit</span></span>
<span><span class="va">maxEff</span> <span class="op">&lt;-</span> <span class="fl">0.12</span> <span class="co"># effect assumed for the highest dose at the last time point</span></span>
<span><span class="va">delta_assumed</span> <span class="op">&lt;-</span> <span class="fu">calcMean</span><span class="op">(</span><span class="va">doses</span>, <span class="va">times</span>, <span class="va">maxEff</span><span class="op">)</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">times</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fl">236</span></span>
<span><span class="va">ia_timing</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span></span>
<span><span class="va">models</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span></span>
<span>  emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">4</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  quadratic <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span>, doses <span class="op">=</span> <span class="va">doses</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">oneSim</span> <span class="op">&lt;-</span> <span class="fu">sim_one_trial</span><span class="op">(</span></span>
<span>  times <span class="op">=</span> <span class="va">times</span>, bslMean <span class="op">=</span> <span class="va">bslMean</span>,</span>
<span>  errSD <span class="op">=</span> <span class="va">errSD</span>, rho <span class="op">=</span> <span class="va">rho</span>, maxEff <span class="op">=</span> <span class="va">maxEff</span>, RecrDist <span class="op">=</span> <span class="va">RecrDist</span>,</span>
<span>  LPFV.t <span class="op">=</span> <span class="va">LPFV.t</span>, models <span class="op">=</span> <span class="va">models</span>, ia_timing <span class="op">=</span> <span class="va">ia_timing</span>, N <span class="op">=</span> <span class="va">N</span>,</span>
<span>  doses <span class="op">=</span> <span class="va">doses</span>, alRatio <span class="op">=</span> <span class="va">alRatio</span>, delta_assumed <span class="op">=</span> <span class="va">delta_assumed</span>,</span>
<span>  alpha <span class="op">=</span> <span class="va">alpha</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">scenRes</span> <span class="op">&lt;-</span> <span class="fu">run_scen</span><span class="op">(</span></span>
<span>  n_sim <span class="op">=</span> <span class="fl">10</span>, rho <span class="op">=</span> <span class="fl">0.9</span>, maxEff <span class="op">=</span> <span class="fl">0.12</span>,</span>
<span>  LPFV.t <span class="op">=</span> <span class="fl">50</span>, ia_timing <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.8</span>, <span class="fl">0.05</span><span class="op">)</span>, delta_assumed <span class="op">=</span> <span class="va">delta_assumed</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-bornkamp2024" class="csl-entry">
Bornkamp, B., Zhou, J., Xi, D., and Cao, W. (2024), <span>“<a href="https://arxiv.org/abs/2406.19965" class="external-link">Futility analyses for the
MCP-mod methodology based on longitudinal models</a>.”</span>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Bornkamp, Jose Pinheiro, Frank Bretz, Ludger Sandig, Marius Thomas, Novartis Pharma AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
