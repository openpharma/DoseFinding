<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Binary Data MCP-Mod • DoseFinding</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Binary Data MCP-Mod">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">DoseFinding</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.1.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/analysis_normal.html">Continuous data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/binary_data.html">Binary Data MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/faq.html">MCP-Mod FAQ</a></li>
    <li><a class="dropdown-item" href="../articles/mult_regimen.html">Multiple Regimen MCP-Mod</a></li>
    <li><a class="dropdown-item" href="../articles/overview.html">Overview DoseFinding package</a></li>
    <li><a class="dropdown-item" href="../articles/sample_size.html">Sample size calculations for MCP-Mod</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/openpharma/DoseFinding/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Binary Data MCP-Mod</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/openpharma/DoseFinding/blob/master/vignettes/binary_data.Rmd" class="external-link"><code>vignettes/binary_data.Rmd</code></a></small>
      <div class="d-none name"><code>binary_data.Rmd</code></div>
    </div>

    
    
<p>In this vignette we illustrate how to use the DoseFinding package
with binary observations by fitting a first-stage GLM and applying the
generalized MCP-Mod methodology to the resulting estimates. We also show
how to deal with covariates.</p>
<p>For continuously distributed data see <a href="analysis_normal.html">the corresponding vignette</a>.</p>
<div class="section level2">
<h2 id="background-and-data-set">Background and data set<a class="anchor" aria-label="anchor" href="#background-and-data-set"></a>
</h2>
<p>Assume a dose-finding study is planned for an hypothetical
investigational treatment in atopic dermatitis, for the binary endpoint
Investigator’s Global Assessment (IGA). The treatment is tested with
doses 0, 0.5, 1.5, 2.5, 4. It is assumed the response rate for placebo
will be around 10%, while the response rate for the top dose may be 35%.
This is an example where the generalized MCP-Mod approach can be
applied, i.e. dose-response testing and estimation will be performed on
the logit scale.</p>
<p>We generate some example data in the setting just described. The 10%
placebo effect translates to -2.2 on the logit scale, and the asymptotic
effect of 25 percentage points above placebo becomes
<code>logit(0.35) - logit(0.1)</code>, approximately 1.6.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/openpharma/DoseFinding" class="external-link">DoseFinding</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">p</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">p</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">y</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">y</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">doses</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.5</span>, <span class="fl">1.5</span>, <span class="fl">2.5</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## set seed and ensure reproducibility across R versions</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1</span>, kind <span class="op">=</span> <span class="st">"Mersenne-Twister"</span>, sample.kind <span class="op">=</span> <span class="st">"Rejection"</span>, normal.kind <span class="op">=</span> <span class="st">"Inversion"</span><span class="op">)</span></span>
<span><span class="va">group_size</span> <span class="op">&lt;-</span> <span class="fl">100</span></span>
<span><span class="va">dose_vector</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">doses</span>, each <span class="op">=</span> <span class="va">group_size</span><span class="op">)</span></span>
<span><span class="va">N</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dose_vector</span><span class="op">)</span></span>
<span><span class="co">## generate covariates</span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A"</span>, <span class="st">"B"</span><span class="op">)</span>, <span class="va">N</span>, replace <span class="op">=</span> <span class="cn">TRUE</span>, prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.6</span>, <span class="fl">0.4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## assume approximately logit(10%) placebo and logit(35%) asymptotic response with ED50=0.5</span></span>
<span><span class="va">prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="fu"><a href="../reference/drmodels.html">emax</a></span><span class="op">(</span><span class="va">dose_vector</span>, <span class="op">-</span><span class="fl">2.2</span>, <span class="fl">1.6</span>, <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="va">x1</span> <span class="op">+</span> <span class="fl">0.3</span> <span class="op">*</span> <span class="op">(</span><span class="va">x2</span> <span class="op">==</span> <span class="st">"B"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">N</span>, <span class="fl">1</span>, <span class="va">prob</span><span class="op">)</span>,</span>
<span>                  dose <span class="op">=</span> <span class="va">dose_vector</span>, x1 <span class="op">=</span> <span class="va">x1</span>, x2 <span class="op">=</span> <span class="va">x2</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="candidate-models">Candidate models<a class="anchor" aria-label="anchor" href="#candidate-models"></a>
</h2>
<p>We will use the following candidate set of models for the mean
response on the logit scale:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">Mods</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.25</span>, <span class="fl">1</span><span class="op">)</span>, sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, betaMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>, <span class="fl">1.1</span><span class="op">)</span>,</span>
<span>             placEff <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, maxEff <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.35</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>             doses <span class="op">=</span> <span class="va">doses</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/Mods.html">plotMods</a></span><span class="op">(</span><span class="va">mods</span><span class="op">)</span></span></code></pre></div>
<p><img src="binary_data_files/figure-html/setup-1.png" width="100%" style="display: block; margin: auto;"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## plot candidate models on probability scale</span></span>
<span><span class="fu"><a href="../reference/Mods.html">plotMods</a></span><span class="op">(</span><span class="va">mods</span>, trafo <span class="op">=</span> <span class="va">inv_logit</span><span class="op">)</span></span></code></pre></div>
<p><img src="binary_data_files/figure-html/setup-2.png" width="100%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="analysis-without-covariates">Analysis without covariates<a class="anchor" aria-label="anchor" href="#analysis-without-covariates"></a>
</h2>
<p>First assume covariates had not been used in the analysis (not
recommended in practice). Let <span class="math inline">\(\mu_k\)</span>
denote the logit response probability at dose <span class="math inline">\(k\)</span>, so that for patient <span class="math inline">\(j\)</span> in group <span class="math inline">\(k\)</span> we have</p>
<p><span class="math display">\[
\begin{aligned}
  Y_{kj} &amp;\sim \mathrm{Bernoulli}(p_{kj}) \\
  \mathrm{logit}(p_{kj}) &amp;= \mu_{k}
\end{aligned}
\]</span></p>
<p>We perform the MCP-Mod test on the logit scale estimates <span class="math inline">\(\hat\mu=(\hat\mu_1,\dots,\hat\mu_K)\)</span> and
their estimated covariance matrix <span class="math inline">\(\hat
S\)</span>. We can extract both from the object returned by the
<code><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm()</a></code> call.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_nocov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dose</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span><span class="va">mu_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_nocov</span><span class="op">)</span></span>
<span><span class="va">S_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">fit_nocov</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/MCTtest.html">MCTtest</a></span><span class="op">(</span><span class="va">doses</span>, <span class="va">mu_hat</span>, S <span class="op">=</span> <span class="va">S_hat</span>, models <span class="op">=</span> <span class="va">mods</span>, type <span class="op">=</span> <span class="st">"general"</span><span class="op">)</span></span></code></pre></div>
<pre><code>Multiple Contrast Test

Contrasts:
     emax1  emax2 sigEmax1 sigEmax2 betaMod
0   -0.817 -0.641   -0.471   -0.280  -0.540
0.5 -0.126 -0.377   -0.589   -0.423  -0.356
1.5  0.202  0.103    0.163   -0.300   0.358
2.5  0.338  0.365    0.418    0.228   0.662
4    0.402  0.550    0.479    0.775  -0.124

Contrast Correlation:
         emax1 emax2 sigEmax1 sigEmax2 betaMod
emax1    1.000 0.945    0.831    0.608   0.789
emax2    0.945 1.000    0.956    0.805   0.762
sigEmax1 0.831 0.956    1.000    0.804   0.788
sigEmax2 0.608 0.805    0.804    1.000   0.327
betaMod  0.789 0.762    0.788    0.327   1.000

Multiple Contrast Test:
         t-Stat   adj-p
emax2     3.378 0.00104
emax1     3.349 0.00103
sigEmax1  3.047 0.00305
sigEmax2  2.668 0.01108
betaMod   2.631 0.01169</code></pre>
<p>Dose-response modeling then can proceed with a combination of
bootstrapping and model averaging. For detailed explanations refer to
the <a href="analysis_normal.html">vignette for analysis of continuous
data</a>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">one_bootstrap_prediction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu_hat</span>, <span class="va">S_hat</span>, <span class="va">doses</span>, <span class="va">bounds</span>, <span class="va">dose_seq</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_hat</span>, <span class="va">S_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"emax"</span>, <span class="st">"sigEmax"</span>, <span class="st">"betaMod"</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/fitMod.html">fitMod</a></span><span class="op">(</span><span class="va">doses</span>, <span class="va">sim</span>, model <span class="op">=</span> <span class="va">mod</span>, S <span class="op">=</span> <span class="va">S_hat</span>, type <span class="op">=</span> <span class="st">"general"</span>, bnds <span class="op">=</span> <span class="va">bounds</span><span class="op">[[</span><span class="va">mod</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">fit</span>, <span class="va">gAIC</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">fit</span><span class="op">[[</span><span class="va">index</span><span class="op">]</span><span class="op">]</span>, doseSeq <span class="op">=</span> <span class="va">dose_seq</span>, predType <span class="op">=</span> <span class="st">"ls-means"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## bs_predictions is a doses x replications matrix,</span></span>
<span><span class="co">## probs is a 4-element vector of increasing probabilities for the quantiles</span></span>
<span><span class="va">summarize_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">bs_predictions</span>, <span class="va">probs</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">probs</span><span class="op">)</span> <span class="op">==</span> <span class="fl">4</span><span class="op">)</span></span>
<span>  <span class="va">med</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bs_predictions</span>, <span class="fl">1</span>, <span class="va">median</span><span class="op">)</span></span>
<span>  <span class="va">quants</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">bs_predictions</span>, <span class="fl">1</span>, <span class="va">quantile</span>, probs <span class="op">=</span> <span class="va">probs</span><span class="op">)</span></span>
<span>  <span class="va">bs_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">med</span>, <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">quants</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">bs_df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"median"</span>, <span class="st">"low_out"</span>, <span class="st">"low_in"</span>, <span class="st">"high_in"</span>, <span class="st">"high_out"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">bs_df</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">predict_and_plot</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu_hat</span>, <span class="va">S_hat</span>, <span class="va">doses</span>, <span class="va">dose_seq</span>, <span class="va">n_rep</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">bs_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span></span>
<span>    <span class="va">n_rep</span>, <span class="fu">one_bootstrap_prediction</span><span class="op">(</span><span class="va">mu_hat</span>, <span class="va">S_hat</span>, <span class="va">doses</span>, <span class="fu"><a href="../reference/defBnds.html">defBnds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>, <span class="va">dose_seq</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">bs_summary</span> <span class="op">&lt;-</span> <span class="fu">summarize_predictions</span><span class="op">(</span><span class="va">bs_rep</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.025</span>, <span class="fl">0.25</span>, <span class="fl">0.75</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">bs_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">bs_summary</span><span class="op">)</span><span class="op">)</span> <span class="co"># back to probability scale</span></span>
<span>  <span class="va">ci_half_width</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="fl">0.975</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">S_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">glm_summary</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="va">doses</span>, mu_hat <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">mu_hat</span><span class="op">)</span>,</span>
<span>                            low <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">mu_hat</span> <span class="op">-</span> <span class="va">ci_half_width</span><span class="op">)</span>,</span>
<span>                            high <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">mu_hat</span> <span class="op">+</span> <span class="va">ci_half_width</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">bs_summary</span>, dose_seq <span class="op">=</span> <span class="va">dose_seq</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">dose_seq</span>, <span class="va">median</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dose_seq</span>, ymin <span class="op">=</span> <span class="va">low_in</span>, ymax <span class="op">=</span> <span class="va">high_in</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">dose_seq</span>, ymin <span class="op">=</span> <span class="va">low_out</span>, ymax <span class="op">=</span> <span class="va">high_out</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">dose</span>, <span class="va">mu_hat</span><span class="op">)</span>, <span class="va">glm_summary</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html" class="external-link">geom_errorbar</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">dose</span>, ymin <span class="op">=</span> <span class="va">low</span>, ymax <span class="op">=</span> <span class="va">high</span><span class="op">)</span>, <span class="va">glm_summary</span>, width <span class="op">=</span> <span class="fl">0</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, <span class="fl">0.05</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Dose"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Response Probability"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Bootstrap estimates for population response probability"</span>,</span>
<span>         subtitle <span class="op">=</span> <span class="st">"confidence levels 50% and 95%"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">dose_seq</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span>, length.out <span class="op">=</span> <span class="fl">51</span><span class="op">)</span></span>
<span><span class="fu">predict_and_plot</span><span class="op">(</span><span class="va">mu_hat</span>, <span class="va">S_hat</span>, <span class="va">doses</span>, <span class="va">dose_seq</span>, <span class="fl">1000</span><span class="op">)</span></span></code></pre></div>
<p><img src="binary_data_files/figure-html/estimate_no_covariates-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="analysis-with-covariates">Analysis with covariates<a class="anchor" aria-label="anchor" href="#analysis-with-covariates"></a>
</h2>
<p>In many situations there are important prognostic covariates (main
effects) to adjust for in the analysis. Denote the vector of these
additional covariates for patient <span class="math inline">\(j\)</span>
with <span class="math inline">\(x_{kj}\)</span>.</p>
<p><span class="math display">\[
\begin{aligned}
  Y_{kj} &amp;\sim \mathrm{Bernoulli}(p_{kj}) \\
  \mathrm{logit}(p_{kj}) &amp;= \mu_k^d + x_{kj}^T\beta
\end{aligned}
\]</span></p>
<p>Fitting this model gives us estimated coefficients <span class="math inline">\(\hat\mu=(\hat\mu^d, \hat\beta)\)</span> and an
estimate <span class="math inline">\(\hat S\)</span> of the covariance
matrix of the estimator <span class="math inline">\(\hat\mu\)</span>.</p>
<p>In principle we could perform testing and estimation based on <span class="math inline">\(\hat\mu^d\)</span> and the corresponding
sub-matrix of <span class="math inline">\(\hat S\)</span>, but this
would produce estimates for a patient with covariate vector <span class="math inline">\(\beta=0\)</span>, and not reflect the overall
population.</p>
<p>To produce adjusted estimates per dose and to accommodate potential
systematic differences in the covariates we predict the mean response
probability at dose k for all observed values of the covariates and
transform back to logit scale:</p>
<p><span class="math display">\[ \mu^*_k :=
\mathrm{logit}\biggl(\frac{1}{n} \sum_{i=1}^n
\mathrm{logit}^{-1}(\hat\mu^d_k + x_{i}^T\hat\beta)\biggr) \]</span></p>
<p>Note here we index <span class="math inline">\(x\)</span> with <span class="math inline">\(i\)</span> that runs from 1 to <span class="math inline">\(n\)</span> (all patients randomized in the
study).</p>
<p>To obtain a variance estimate for <span class="math inline">\(\mu^*\)</span> we repeat this with draws from
<span class="math inline">\(\mathrm{MultivariateNormal}(\hat\mu, \hat
S)\)</span> and calculate the empirical covariance matrix <span class="math inline">\(S^*\)</span> of theses draws.</p>
<p>Then we use <span class="math inline">\(\mu^*\)</span> and <span class="math inline">\(S^*\)</span> in <code><a href="../reference/MCTtest.html">MCTtest()</a></code>.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html" class="external-link">glm</a></span><span class="op">(</span><span class="va">y</span><span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dose</span><span class="op">)</span> <span class="op">+</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">x1</span> <span class="op">+</span> <span class="va">x2</span>, data <span class="op">=</span> <span class="va">dat</span>, family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span>
<span></span>
<span><span class="va">covariate_adjusted_estimates</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mu_hat</span>, <span class="va">S_hat</span>, <span class="va">formula_rhs</span>, <span class="va">doses</span>, <span class="va">other_covariates</span>, <span class="va">n_sim</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## predict every patient under *every* dose</span></span>
<span>  <span class="va">oc_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">other_covariates</span>, <span class="kw">function</span><span class="op">(</span><span class="va">col</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">col</span>, times <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">d_rep</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">doses</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">other_covariates</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pdat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">oc_rep</span>, dose <span class="op">=</span> <span class="va">d_rep</span><span class="op">)</span></span>
<span>  <span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">formula_rhs</span>, <span class="va">pdat</span><span class="op">)</span></span>
<span>  <span class="co">## average on probability scale then backtransform to logit scale</span></span>
<span>  <span class="va">mu_star</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">mu_hat</span><span class="op">)</span>, <span class="va">pdat</span><span class="op">$</span><span class="va">dose</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## estimate covariance matrix of mu_star</span></span>
<span>  <span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">n_sim</span>, <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">X</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/drop.html" class="external-link">drop</a></span><span class="op">(</span><span class="fu">mvtnorm</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/mvtnorm/man/Mvnorm.html" class="external-link">rmvnorm</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">mu_hat</span>, <span class="va">S_hat</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                                        <span class="va">pdat</span><span class="op">$</span><span class="va">dose</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mu_star <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">mu_star</span><span class="op">)</span>, S_star <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">cov</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">pred</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ca</span> <span class="op">&lt;-</span> <span class="fu">covariate_adjusted_estimates</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">fit_cov</span><span class="op">)</span>, <span class="op">~</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">dose</span><span class="op">)</span><span class="op">+</span><span class="fl">0</span><span class="op">+</span><span class="va">x1</span><span class="op">+</span><span class="va">x2</span>,</span>
<span>                                   <span class="va">doses</span>, <span class="va">dat</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"x1"</span>, <span class="st">"x2"</span><span class="op">)</span><span class="op">]</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/MCTtest.html">MCTtest</a></span><span class="op">(</span><span class="va">doses</span>, <span class="va">ca</span><span class="op">$</span><span class="va">mu_star</span>, S <span class="op">=</span> <span class="va">ca</span><span class="op">$</span><span class="va">S_star</span>, type <span class="op">=</span> <span class="st">"general"</span>, models <span class="op">=</span> <span class="va">mods</span><span class="op">)</span></span></code></pre></div>
<pre><code>Multiple Contrast Test

Contrasts:
     emax1  emax2 sigEmax1 sigEmax2 betaMod
0   -0.828 -0.659   -0.494   -0.277  -0.551
0.5 -0.067 -0.317   -0.546   -0.369  -0.299
1.5  0.131  0.021    0.090   -0.372   0.315
2.5  0.384  0.412    0.470    0.251   0.694
4    0.381  0.543    0.480    0.766  -0.160

Contrast Correlation:
         emax1 emax2 sigEmax1 sigEmax2 betaMod
emax1    1.000 0.945    0.829    0.598   0.785
emax2    0.945 1.000    0.954    0.799   0.750
sigEmax1 0.829 0.954    1.000    0.797   0.777
sigEmax2 0.598 0.799    0.797    1.000   0.299
betaMod  0.785 0.750    0.777    0.299   1.000

Multiple Contrast Test:
         t-Stat   adj-p
emax2     3.491 &lt; 0.001
emax1     3.471 &lt; 0.001
sigEmax1  3.115 0.00238
sigEmax2  2.749 0.00888
betaMod   2.639 0.01215</code></pre>
<p>In the case at hand the results here are not dramatically different.
Adjusting for covariates gives slightly lower variance estimates.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>dose <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">doses</span>, <span class="fl">4</span><span class="op">)</span>,</span>
<span>                  est <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">mu_hat</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">S_hat</span><span class="op">)</span>, <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">ca</span><span class="op">$</span><span class="va">mu_star</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">ca</span><span class="op">$</span><span class="va">S_star</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"var"</span><span class="op">)</span>, each <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span>, times <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>                  a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="cn">FALSE</span>, <span class="cn">TRUE</span><span class="op">)</span>, each <span class="op">=</span> <span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">doses</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">dose</span>, <span class="va">est</span>, color <span class="op">=</span> <span class="va">a</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"adjusted"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/vars.html" class="external-link">vars</a></span><span class="op">(</span><span class="va">name</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">""</span><span class="op">)</span></span></code></pre></div>
<p><img src="binary_data_files/figure-html/compare-1.png" width="85%" style="display: block; margin: auto;"></p>
<p>Dose-response modelling proceeds in the same way as before, but now
on the adjusted estimates.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">predict_and_plot</span><span class="op">(</span><span class="va">ca</span><span class="op">$</span><span class="va">mu_star</span>, <span class="va">ca</span><span class="op">$</span><span class="va">S_star</span>, <span class="va">doses</span>, <span class="va">dose_seq</span>, <span class="fl">1000</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Covariate adjusted bootstrap estimates for population response probability"</span><span class="op">)</span></span></code></pre></div>
<p><img src="binary_data_files/figure-html/estimate_covariates-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2">
<h2 id="avoiding-problems-with-complete-seperation-and-0-responders">Avoiding problems with complete seperation and 0 responders<a class="anchor" aria-label="anchor" href="#avoiding-problems-with-complete-seperation-and-0-responders"></a>
</h2>
<p>In a number of situations it makes sense to replace ML estimation for
logistic regression via <code>glm(..., family=binomial)</code>, with the
Firth logistic regression <span class="citation">(see <a href="#ref-heinze2002">Heinze and Schemper 2002</a>)</span>, implemented
as the <code>logistf</code> function from the <code>logistf</code>
package. This is particularly important for small sample size per dose
and if small number of responses are expected on some treatment arms.
The estimator of Firth regression corresponds to the posterior mode in a
Bayesian logistic regression model with Jeffrey’s prior on the parameter
vector. This estimator is well defined even in situations where the ML
estimate for logistic regression does not exist (e.g. for complete
separation).</p>
</div>
<div class="section level2">
<h2 id="considerations-around-optimal-contrasts-at-design-stage-and-analysis-stage">Considerations around optimal contrasts at design stage and analysis
stage<a class="anchor" aria-label="anchor" href="#considerations-around-optimal-contrasts-at-design-stage-and-analysis-stage"></a>
</h2>
<p>The formula for the optimal contrasts is given by <span class="math display">\[
c^{\textrm{opt}} \propto
S^{-1}\biggl(\mu^0_m - \frac{(\mu^0_m)^T S^{-1}1_K}{1_K^T S^{-1}
1_K}\biggr)
\]</span> where <span class="math inline">\(\mu^0_m\)</span> is the
standardized mean response, <span class="math inline">\(K\)</span> is
the number doses, and <span class="math inline">\(1_K\)</span> is an
all-ones vector of length <span class="math inline">\(K\)</span> and
<span class="math inline">\(S\)</span> is the covariance matrix of the
estimates at the doses <span class="citation">(see <a href="#ref-pinheiro2014">Pinheiro et al. 2014</a>)</span>.</p>
<p>For calculating the optimal contrast for the generalized MCP step the
covariance matrix <span class="math inline">\(S\)</span> of the
estimator <span class="math inline">\(\hat\mu\)</span> can be
re-estimated once the trial data are available. With normally
distributed data this is possible with decent accuracy even at rather
low sample sizes. In the case of binary data, <span class="math inline">\(\hat\mu\)</span> is on the logit scale and the
diagonal elements of <span class="math inline">\(S\)</span> are
approximately <span class="math inline">\((np(1-p))^{-1}\)</span>, where
<span class="math inline">\(n\)</span> is the sample size of the dose
group. This can be derived using the delta method. An estimate of this
variance depends on the observed response rate and can thus be quite
variable in particular for small sample sizes per group (e.g. smaller
than 20).</p>
<p>A crude alternative in these situations is to not use the estimated
<span class="math inline">\(S\)</span> but a diagonal matrix with the
inverse of the sample size per dose on the diagonal in the formula for
calculation of the optimal contrast. The contrast calculated this way
will asymptotically not be equal to the “optimal” contrast for the
underlying model, but simulations show that they can be closer to the
“true” optimal contrast (calculated based on the true variance per dose
group) for small sample size, compared to the contrast calculated based
on the estimated variance.</p>
<p>To re-run the adjusted analysis above for the contrasts, calculated
as outlined above, we need to calculate and hand-over the contrast
matrix manually via <code>contMat</code> in the <code><a href="../reference/MCTtest.html">MCTtest()</a></code>
function. In our case (with 100 patients per group) we obtain a result
that is only slightly different.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## here we have balanced sample sizes across groups, so we select w = 1</span></span>
<span><span class="co">## otherwise would select w proportional to group sample sizes</span></span>
<span><span class="va">optCont</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span><span class="va">mods</span>, <span class="va">doses</span>, w <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/MCTtest.html">MCTtest</a></span><span class="op">(</span><span class="va">doses</span>, <span class="va">ca</span><span class="op">$</span><span class="va">mu_star</span>, S <span class="op">=</span> <span class="va">ca</span><span class="op">$</span><span class="va">S_star</span>, type <span class="op">=</span> <span class="st">"general"</span>, contMat <span class="op">=</span> <span class="va">optCont</span><span class="op">)</span></span></code></pre></div>
<pre><code>Multiple Contrast Test

Contrasts:
     emax1  emax2 sigEmax1 sigEmax2 betaMod
0   -0.861 -0.753   -0.597   -0.391  -0.679
0.5 -0.010 -0.240   -0.479   -0.389  -0.255
1.5  0.233  0.170    0.223   -0.240   0.383
2.5  0.299  0.346    0.402    0.268   0.573
4    0.340  0.477    0.450    0.752  -0.022

Contrast Correlation:
         emax1 emax2 sigEmax1 sigEmax2 betaMod
emax1    1.000 0.965    0.863    0.659   0.884
emax2    0.965 1.000    0.959    0.811   0.882
sigEmax1 0.863 0.959    1.000    0.836   0.879
sigEmax2 0.659 0.811    0.836    1.000   0.522
betaMod  0.884 0.882    0.879    0.522   1.000

Multiple Contrast Test:
         t-Stat   adj-p
emax2     3.427 &lt; 0.001
emax1     3.318 0.00118
sigEmax1  3.166 0.00193
sigEmax2  3.055 0.00255
betaMod   2.907 0.00466</code></pre>
</div>
<div class="section level2">
<h2 id="power-and-sample-size-considerations">Power and sample size considerations<a class="anchor" aria-label="anchor" href="#power-and-sample-size-considerations"></a>
</h2>
<p>We can calculate the power under each of the candidate models from
the top of this vignette. For example, we assume a
<code>Mods(emax = 0.25)</code> and calculate the vector of mean
responses <code>lo</code> on the logit scale. When we transform it back
to probability scale <code>p</code>, we can calculate the approximate
variance of the (logit-scale) estimator <code>mu_hat</code> with the
formula <span class="math display">\[ \mathrm{Var}(\hat\mu) =
\frac{1}{np(1-p)} \]</span> (see the section above). Next we calculate
the minimum power across the candidate set using <code><a href="../reference/powMCT.html">powMCT()</a></code>
and plot it for increasing <code>n</code>.</p>
<p>See also the <a href="sample_size.html">vignette on sample size
calculation</a>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## for simplicity: contrasts as discussed in the previous section</span></span>
<span><span class="va">contMat</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/optContr.html">optContr</a></span><span class="op">(</span><span class="va">mods</span>, w<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## we need each alternative model as a separate object</span></span>
<span><span class="va">alt_model_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>emax <span class="op">=</span> <span class="fl">0.25</span>, emax <span class="op">=</span> <span class="fl">1</span>, sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>,</span>
<span>                      sigEmax <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2.5</span>, <span class="fl">4</span><span class="op">)</span>, betaMod <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1.1</span>, <span class="fl">1.1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">alt_common_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>placEff <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>, maxEff <span class="op">=</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.35</span><span class="op">)</span><span class="op">-</span><span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">logit</a></span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>,</span>
<span>                       doses <span class="op">=</span> <span class="va">doses</span><span class="op">)</span></span>
<span><span class="co">## this is a bit hackish because we need to pass named arguments to Mods()</span></span>
<span><span class="va">alt_mods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">alt_model_par</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">Mods</span>, <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="va">alt_model_par</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">alt_common_par</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">prop_true_var_mu_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">alt_model_par</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## mean responses on logit scale</span></span>
<span>  <span class="va">lo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/Mods.html">getResp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">Mods</span>, <span class="fu"><a href="https://rdrr.io/r/base/append.html" class="external-link">append</a></span><span class="op">(</span><span class="va">alt_model_par</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>, <span class="va">alt_common_par</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://opensource.nibr.com/RBesT/reference/lodds.html" class="external-link">inv_logit</a></span><span class="op">(</span><span class="va">lo</span><span class="op">)</span> <span class="co"># mean responses on probability scale</span></span>
<span>  <span class="va">v</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">p</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span><span class="op">-</span><span class="va">p</span><span class="op">)</span><span class="op">)</span> <span class="co"># element-wise variance of mu_hat up to a factor of 1/n</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">v</span><span class="op">)</span><span class="op">)</span> <span class="co"># drop unnecessary attributes</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span></span>
<span><span class="va">min_power_at_group_size</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">pwr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mapply.html" class="external-link">mapply</a></span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="va">m</span>, <span class="va">v</span><span class="op">)</span> <span class="fu"><a href="../reference/powMCT.html">powMCT</a></span><span class="op">(</span><span class="va">contMat</span>, alpha<span class="op">=</span><span class="fl">0.025</span>, altModels<span class="op">=</span><span class="va">m</span>, S<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="va">v</span><span class="op">/</span><span class="va">n</span><span class="op">)</span>, df<span class="op">=</span><span class="cn">Inf</span><span class="op">)</span>,</span>
<span>                <span class="va">alt_mods</span>, <span class="va">prop_true_var_mu_hat</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">pwr</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">5</span>, <span class="fl">80</span>, by<span class="op">=</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="va">pwrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">min_power_at_group_size</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/qplot.html" class="external-link">qplot</a></span><span class="op">(</span><span class="va">n</span>, <span class="va">pwrs</span>, geom<span class="op">=</span><span class="st">"line"</span>, ylab<span class="op">=</span><span class="st">"Min. Power over candidate set"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,by<span class="op">=</span><span class="fl">0.1</span><span class="op">)</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>Warning:  [1m [22m`qplot()` was deprecated in ggplot2 3.4.0.
 [90mThis warning is displayed once every 8 hours. [39m
 [90mCall `lifecycle::last_lifecycle_warnings()` to see where this warning was [39m
 [90mgenerated. [39m</code></pre>
<p><img src="binary_data_files/figure-html/sample_size-1.png" width="85%" style="display: block; margin: auto;"></p>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-heinze2002" class="csl-entry">
Heinze, G., and Schemper, M. (2002), <span>“A solution to the problem of
separation in logistic regression,”</span> <em>Statistics in
Medicine</em>, 21, 2409–2419. <a href="https://doi.org/10.1002/sim.1047" class="external-link">https://doi.org/10.1002/sim.1047</a>.
</div>
<div id="ref-pinheiro2014" class="csl-entry">
Pinheiro, J., Bornkamp, B., Glimm, E., and Bretz, F. (2014),
<span>“Model-based dose finding under model uncertainty using general
parametric models,”</span> <em>Statistics in Medicine</em>, 33,
1646–1661. <a href="https://doi.org/10.1002/sim.6052" class="external-link">https://doi.org/10.1002/sim.6052</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Bjoern Bornkamp, Jose Pinheiro, Frank Bretz, Ludger Sandig, Marius Thomas, Novartis Pharma AG.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
